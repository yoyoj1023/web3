# 第三課：在前端頁面展示數據

### 🎯 學習目標

在這一課中，我們將：
- 將 `useTokenHolders` Hook 整合到富豪榜頁面
- 建立 API 路由來安全地調用 Alchemy API
- 優化數據展示和用戶體驗
- 實作實時數據更新和錯誤處理
- 加入載入動畫和狀態反饋

### 🔧 建立 API 路由

首先，我們需要建立後端 API 路由來安全地調用 Alchemy API，避免在前端暴露 API Key。

#### 建立代幣持有者 API

建立 `packages/nextjs/app/api/token-holders/route.ts`：

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { isAddress } from 'viem';

// Alchemy API 配置
const ALCHEMY_API_KEY = process.env.ALCHEMY_API_KEY;
const ALCHEMY_BASE_URL = 'https://opt-sepolia.g.alchemy.com/v2';

interface AlchemyError {
  error: {
    code: number;
    message: string;
  };
}

interface TokenHoldersRequest {
  contractAddress: string;
  pageSize?: number;
  pageKey?: string;
}

export async function POST(request: NextRequest) {
  try {
    // 檢查 API Key 配置
    if (!ALCHEMY_API_KEY) {
      return NextResponse.json(
        { error: 'API Key not configured' },
        { status: 500 }
      );
    }

    // 解析請求數據
    const body: TokenHoldersRequest = await request.json();
    const { contractAddress, pageSize = 1000, pageKey } = body;

    // 驗證輸入
    if (!contractAddress) {
      return NextResponse.json(
        { error: '代幣地址不能為空' },
        { status: 400 }
      );
    }

    if (!isAddress(contractAddress)) {
      return NextResponse.json(
        { error: '無效的以太坊地址格式' },
        { status: 400 }
      );
    }

    if (pageSize < 1 || pageSize > 1000) {
      return NextResponse.json(
        { error: '頁面大小必須在 1-1000 之間' },
        { status: 400 }
      );
    }

    // 準備 API 請求參數
    const params = new URLSearchParams({
      contractAddress: contractAddress.toLowerCase(),
      withTokenBalances: 'true',
      pageSize: pageSize.toString(),
    });

    if (pageKey) {
      params.append('pageKey', pageKey);
    }

    // 調用 Alchemy API
    const alchemyUrl = `${ALCHEMY_BASE_URL}/${ALCHEMY_API_KEY}/getOwnersForContract?${params}`;
    
    const response = await fetch(alchemyUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
    });

    if (!response.ok) {
      const errorData: AlchemyError = await response.json();
      
      // 轉換 Alchemy 錯誤為友善訊息
      const friendlyMessage = formatAlchemyError(response.status, errorData);
      
      return NextResponse.json(
        { error: friendlyMessage },
        { status: response.status }
      );
    }

    const data = await response.json();

    // 驗證回應格式
    if (!data.owners || !Array.isArray(data.owners)) {
      return NextResponse.json(
        { error: 'API 回應格式異常' },
        { status: 500 }
      );
    }

    return NextResponse.json(data);

  } catch (error) {
    console.error('Token holders API error:', error);
    
    return NextResponse.json(
      { error: '獲取代幣持有者數據時發生錯誤' },
      { status: 500 }
    );
  }
}

/**
 * 格式化 Alchemy API 錯誤訊息
 */
function formatAlchemyError(status: number, errorData?: AlchemyError): string {
  switch (status) {
    case 400:
      return '請求參數錯誤，請檢查代幣地址格式';
    case 401:
      return 'API 認證失敗，請聯絡管理員';
    case 403:
      return 'API 請求額度已用完，請稍後再試';
    case 404:
      return '找不到指定的代幣合約';
    case 429:
      return '請求過於頻繁，請稍後再試';
    case 500:
    case 502:
    case 503:
      return '服務暫時不可用，請稍後再試';
    default:
      return errorData?.error?.message || '發生未預期的錯誤';
  }
}
```

#### 建立代幣元數據 API

建立 `packages/nextjs/app/api/token-metadata/route.ts`：

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { isAddress } from 'viem';

const ALCHEMY_API_KEY = process.env.ALCHEMY_API_KEY;
const ALCHEMY_BASE_URL = 'https://opt-sepolia.g.alchemy.com/v2';

interface TokenMetadataRequest {
  contractAddress: string;
}

export async function POST(request: NextRequest) {
  try {
    if (!ALCHEMY_API_KEY) {
      return NextResponse.json(
        { error: 'API Key not configured' },
        { status: 500 }
      );
    }

    const body: TokenMetadataRequest = await request.json();
    const { contractAddress } = body;

    // 驗證輸入
    if (!contractAddress || !isAddress(contractAddress)) {
      return NextResponse.json(
        { error: '無效的代幣地址' },
        { status: 400 }
      );
    }

    // 調用 Alchemy API
    const params = new URLSearchParams({
      contractAddress: contractAddress.toLowerCase(),
    });

    const alchemyUrl = `${ALCHEMY_BASE_URL}/${ALCHEMY_API_KEY}/getTokenMetadata?${params}`;
    
    const response = await fetch(alchemyUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
    });

    if (!response.ok) {
      const errorData = await response.json();
      const friendlyMessage = formatAlchemyError(response.status, errorData);
      
      return NextResponse.json(
        { error: friendlyMessage },
        { status: response.status }
      );
    }

    const data = await response.json();

    // 標準化回應格式
    const tokenData = {
      name: data.name || 'Unknown Token',
      symbol: data.symbol || 'UNKNOWN',
      decimals: data.decimals || 18,
      totalSupply: data.totalSupply || '0',
      contractAddress: contractAddress.toLowerCase(),
    };

    return NextResponse.json(tokenData);

  } catch (error) {
    console.error('Token metadata API error:', error);
    
    return NextResponse.json(
      { error: '獲取代幣資訊時發生錯誤' },
      { status: 500 }
    );
  }
}

function formatAlchemyError(status: number, errorData?: any): string {
  switch (status) {
    case 400:
      return '請求參數錯誤，請檢查代幣地址格式';
    case 401:
      return 'API 認證失敗，請聯絡管理員';
    case 404:
      return '找不到指定的代幣合約或該合約不是有效的 ERC20 代幣';
    case 429:
      return '請求過於頻繁，請稍後再試';
    case 500:
      return '服務暫時不可用，請稍後再試';
    default:
      return errorData?.error?.message || '發生未預期的錯誤';
  }
}
```

### 🔄 更新 useTokenHolders Hook

更新我們的 Hook 以使用新的 API 路由：

```typescript
// hooks/utils/alchemyApi.ts (更新版本)
export class AlchemyApi {
  /**
   * 通過 Next.js API 路由獲取代幣持有者
   */
  async getTokenHolders(
    contractAddress: string,
    options: {
      pageSize?: number;
      pageKey?: string;
    } = {}
  ): Promise<AlchemyResponse> {
    const { pageSize = 1000, pageKey } = options;

    try {
      const response = await fetch('/api/token-holders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contractAddress,
          pageSize,
          pageKey,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new AlchemyApiError(
          errorData.error || 'API request failed',
          response.status
        );
      }

      const data = await response.json();
      return data;
    } catch (error) {
      if (error instanceof AlchemyApiError) {
        throw error;
      }
      
      throw new AlchemyApiError(
        'Failed to fetch token holders',
        undefined,
        error
      );
    }
  }

  /**
   * 通過 Next.js API 路由獲取代幣元數據
   */
  async getTokenMetadata(contractAddress: string): Promise<TokenData> {
    try {
      const response = await fetch('/api/token-metadata', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contractAddress,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new AlchemyApiError(
          errorData.error || 'API request failed',
          response.status
        );
      }

      const data = await response.json();
      return data;
    } catch (error) {
      if (error instanceof AlchemyApiError) {
        throw error;
      }
      
      throw new AlchemyApiError(
        'Failed to fetch token metadata',
        undefined,
        error
      );
    }
  }

  /**
   * 獲取所有代幣持有者（處理分頁）
   */
  async getAllTokenHolders(contractAddress: string): Promise<AlchemyResponse> {
    let allOwners: any[] = [];
    let pageKey: string | null = null;
    let totalCount = 0;

    do {
      const response = await this.getTokenHolders(contractAddress, {
        pageKey: pageKey || undefined,
        pageSize: 1000,
      });

      allOwners = allOwners.concat(response.owners);
      pageKey = response.pageKey;
      totalCount = response.totalCount;

      // 避免請求過於頻繁
      if (pageKey) {
        await this.delay(200);
      }

      // 安全檢查：避免無限循環
      if (allOwners.length > 10000) {
        console.warn('Token holders count exceeds 10,000, stopping pagination');
        break;
      }

    } while (pageKey);

    return {
      owners: allOwners,
      pageKey: null,
      totalCount: allOwners.length
    };
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// 建立預設實例
export const alchemyApi = new AlchemyApi();
```

### 🎨 更新富豪榜頁面

現在讓我們更新富豪榜頁面以使用新的 Hook：

```typescript
// app/rich-list/page.tsx (更新版本)
"use client";

import { useState } from "react";
import { NextPage } from "next";
import { AddressInput, IntegerInput } from "~~/components/scaffold-alchemy";
import { useTokenHolders } from "~~/hooks/useTokenHolders";
import { TokenInfoCard } from "./_components/TokenInfoCard";
import { RichListTable } from "./_components/RichListTable";
import { LoadingSpinner } from "./_components/LoadingSpinner";
import { ErrorMessage } from "./_components/ErrorMessage";
import { StatsCards } from "./_components/StatsCards";
import { SearchHistory } from "./_components/SearchHistory";
import { isAddress } from "viem";

const RichListPage: NextPage = () => {
  // 表單狀態
  const [tokenAddress, setTokenAddress] = useState<string>("");
  const [pageSize, setPageSize] = useState<bigint>(BigInt(20));
  
  // 搜尋歷史
  const [searchHistory, setSearchHistory] = useState<string[]>([]);
  
  // 使用我們的自定義 Hook
  const {
    tokenData,
    holders,
    totalHolders,
    isLoading,
    error,
    stats,
    fetchTokenHolders,
    refetch,
    clearData,
    findHolder,
  } = useTokenHolders();

  // 處理搜尋
  const handleSearch = async () => {
    if (!isAddress(tokenAddress)) {
      alert("請輸入有效的以太坊地址");
      return;
    }
    
    try {
      await fetchTokenHolders(tokenAddress, {
        withCache: true,
        forceRefresh: false,
      });
      
      // 添加到搜尋歷史
      setSearchHistory(prev => {
        const newHistory = [tokenAddress, ...prev.filter(addr => addr !== tokenAddress)];
        return newHistory.slice(0, 5); // 只保留最近 5 個
      });
    } catch (error) {
      console.error('Search failed:', error);
    }
  };

  // 處理歷史搜尋
  const handleHistorySearch = async (address: string) => {
    setTokenAddress(address);
    await fetchTokenHolders(address);
  };

  // 處理地址搜尋
  const handleAddressSearch = () => {
    const searchAddress = prompt('輸入要搜尋的持有者地址:');
    if (searchAddress && isAddress(searchAddress)) {
      const holder = findHolder(searchAddress);
      if (holder) {
        alert(`找到持有者！\n排名: #${holder.rank}\n餘額: ${holder.balanceFormatted} ${tokenData?.symbol}\n佔比: ${holder.percentage.toFixed(4)}%`);
      } else {
        alert('未找到該地址的持有記錄');
      }
    } else if (searchAddress) {
      alert('請輸入有效的以太坊地址');
    }
  };

  // 計算顯示的持有者
  const displayedHolders = holders.slice(0, Number(pageSize));

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
      <div className="container mx-auto px-4 py-8 max-w-7xl">
        
        {/* 頁面標題 */}
        <div className="text-center mb-12">
          <h1 className="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
            🏆 ERC20 富豪榜查詢
          </h1>
          <p className="text-lg text-gray-600 max-w-2xl mx-auto">
            輸入任何 ERC20 代幣合約地址，即時查看代幣持有者排行榜。
            支援所有 Optimism Sepolia 網路上的代幣。
          </p>
        </div>

        {/* 搜尋區域 */}
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-8">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-semibold text-gray-800">
              🔍 代幣查詢
            </h2>
            
            {/* 操作按鈕 */}
            <div className="flex gap-2">
              <button
                onClick={refetch}
                disabled={!tokenData || isLoading}
                className="bg-gray-600 hover:bg-gray-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg text-sm transition-colors"
              >
                🔄 重新整理
              </button>
              <button
                onClick={clearData}
                disabled={isLoading}
                className="bg-red-600 hover:bg-red-700 disabled:bg-red-400 text-white px-4 py-2 rounded-lg text-sm transition-colors"
              >
                🗑️ 清除
              </button>
              <button
                onClick={handleAddressSearch}
                disabled={holders.length === 0 || isLoading}
                className="bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white px-4 py-2 rounded-lg text-sm transition-colors"
              >
                🔎 搜尋持有者
              </button>
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            {/* 代幣地址輸入 */}
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                代幣合約地址
              </label>
              <AddressInput
                value={tokenAddress}
                onChange={setTokenAddress}
                placeholder="0x1234567890abcdef..."
                className="w-full"
                disabled={isLoading}
              />
              <p className="text-xs text-gray-500 mt-1">
                請輸入有效的 ERC20 代幣合約地址
              </p>
            </div>

            {/* 顯示數量 */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                顯示數量
              </label>
              <IntegerInput
                value={pageSize}
                onChange={setPageSize}
                placeholder="20"
                className="w-full"
                disabled={isLoading}
              />
              <p className="text-xs text-gray-500 mt-1">
                1-100 個項目
              </p>
            </div>

            {/* 搜尋按鈕 */}
            <div className="flex items-end">
              <button
                onClick={handleSearch}
                disabled={!tokenAddress || isLoading}
                className="
                  w-full h-12
                  bg-gradient-to-r from-blue-600 to-purple-600
                  hover:from-blue-700 hover:to-purple-700
                  disabled:from-gray-400 disabled:to-gray-500
                  disabled:cursor-not-allowed
                  text-white font-semibold
                  rounded-xl
                  transition-all duration-300
                  transform hover:scale-105 disabled:hover:scale-100
                  shadow-lg hover:shadow-xl
                "
              >
                {isLoading ? (
                  <div className="flex items-center justify-center gap-2">
                    <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                    查詢中...
                  </div>
                ) : (
                  "🚀 查詢富豪榜"
                )}
              </button>
            </div>
          </div>

          {/* 搜尋歷史 */}
          {searchHistory.length > 0 && (
            <SearchHistory
              history={searchHistory}
              onSelect={handleHistorySearch}
              isLoading={isLoading}
            />
          )}
        </div>

        {/* 錯誤訊息 */}
        {error && (
          <ErrorMessage 
            message={error}
            onRetry={refetch}
            className="mb-8"
          />
        )}

        {/* 載入狀態 */}
        {isLoading && (
          <LoadingSpinner 
            message="正在獲取富豪榜數據..."
            details="這可能需要幾秒鐘時間，請耐心等候"
            className="mb-8"
          />
        )}

        {/* 代幣資訊卡片 */}
        {tokenData && !error && (
          <TokenInfoCard 
            tokenData={tokenData}
            totalHolders={totalHolders}
            className="mb-8"
          />
        )}

        {/* 統計資訊卡片 */}
        {holders.length > 0 && !isLoading && !error && (
          <StatsCards 
            stats={stats}
            tokenSymbol={tokenData?.symbol || 'TOKEN'}
            className="mb-8"
          />
        )}

        {/* 富豪榜表格 */}
        {holders.length > 0 && !isLoading && !error && (
          <RichListTable
            holders={displayedHolders}
            tokenSymbol={tokenData?.symbol || "TOKEN"}
            totalSupply={tokenData?.totalSupply}
            showRanking={true}
            className="mb-8"
          />
        )}

        {/* 顯示更多按鈕 */}
        {holders.length > Number(pageSize) && (
          <div className="text-center">
            <button
              onClick={() => setPageSize(prev => prev + BigInt(20))}
              className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-medium transition-colors"
            >
              顯示更多持有者 ({holders.length - Number(pageSize)} 個剩餘)
            </button>
          </div>
        )}

        {/* 空狀態 */}
        {holders.length === 0 && !isLoading && !error && tokenAddress && (
          <div className="text-center py-16">
            <div className="text-6xl mb-4">🔍</div>
            <h3 className="text-xl font-semibold text-gray-700 mb-2">
              未找到持有者數據
            </h3>
            <p className="text-gray-500 mb-4">
              請確認代幣地址正確，或該代幣可能沒有持有者。
            </p>
            <button
              onClick={() => setTokenAddress("")}
              className="text-blue-600 hover:text-blue-700 font-medium"
            >
              重新輸入地址
            </button>
          </div>
        )}

        {/* 初始狀態 */}
        {!tokenAddress && !isLoading && (
          <div className="text-center py-16">
            <div className="text-6xl mb-4">🎯</div>
            <h3 className="text-xl font-semibold text-gray-700 mb-2">
              開始查詢富豪榜
            </h3>
            <p className="text-gray-500 mb-6">
              輸入 ERC20 代幣合約地址，查看持有者排行榜。
            </p>
            
            {/* 範例地址 */}
            <div className="bg-gray-50 rounded-lg p-4 max-w-md mx-auto">
              <p className="text-sm text-gray-600 mb-2">試試這些範例地址：</p>
              <div className="space-y-2">
                <button
                  onClick={() => setTokenAddress("0x1234567890123456789012345678901234567890")}
                  className="block w-full text-left font-mono text-sm text-blue-600 hover:text-blue-700 p-2 rounded hover:bg-blue-50"
                >
                  0x1234...7890 (範例代幣)
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default RichListPage;
```

### 📊 新增統計卡片組件

建立 `app/rich-list/_components/StatsCards.tsx`：

```typescript
interface StatsCardsProps {
  stats: {
    totalHolders: number;
    totalBalance: number;
    averageBalance: number;
    medianBalance: number;
    top10Percentage: number;
  };
  tokenSymbol: string;
  className?: string;
}

export function StatsCards({ stats, tokenSymbol, className = "" }: StatsCardsProps) {
  const formatNumber = (num: number, decimals: number = 2) => {
    if (num >= 1000000) {
      return `${(num / 1000000).toFixed(decimals)}M`;
    } else if (num >= 1000) {
      return `${(num / 1000).toFixed(decimals)}K`;
    }
    return num.toFixed(decimals);
  };

  const statsData = [
    {
      title: "總持有者",
      value: stats.totalHolders.toLocaleString(),
      icon: "👥",
      color: "bg-blue-500",
      bgColor: "bg-blue-50",
      textColor: "text-blue-700"
    },
    {
      title: "平均持有量",
      value: `${formatNumber(stats.averageBalance)} ${tokenSymbol}`,
      icon: "📊",
      color: "bg-green-500",
      bgColor: "bg-green-50",
      textColor: "text-green-700"
    },
    {
      title: "中位數持有量",
      value: `${formatNumber(stats.medianBalance)} ${tokenSymbol}`,
      icon: "📈",
      color: "bg-purple-500",
      bgColor: "bg-purple-50",
      textColor: "text-purple-700"
    },
    {
      title: "前10名佔比",
      value: `${stats.top10Percentage.toFixed(1)}%`,
      icon: "🏆",
      color: "bg-orange-500",
      bgColor: "bg-orange-50",
      textColor: "text-orange-700"
    }
  ];

  return (
    <div className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 ${className}`}>
      {statsData.map((stat, index) => (
        <div key={index} className={`${stat.bgColor} rounded-xl p-6 border border-opacity-20`}>
          <div className="flex items-center justify-between mb-4">
            <div className={`w-12 h-12 ${stat.color} rounded-lg flex items-center justify-center text-white text-xl`}>
              {stat.icon}
            </div>
            <div className="text-right">
              <div className={`text-2xl font-bold ${stat.textColor}`}>
                {stat.value}
              </div>
            </div>
          </div>
          <div className={`text-sm font-medium ${stat.textColor} opacity-80`}>
            {stat.title}
          </div>
        </div>
      ))}
    </div>
  );
}
```

### 🕒 新增搜尋歷史組件

建立 `app/rich-list/_components/SearchHistory.tsx`：

```typescript
interface SearchHistoryProps {
  history: string[];
  onSelect: (address: string) => void;
  isLoading: boolean;
  className?: string;
}

export function SearchHistory({ 
  history, 
  onSelect, 
  isLoading, 
  className = "" 
}: SearchHistoryProps) {
  if (history.length === 0) return null;

  return (
    <div className={`border-t pt-4 ${className}`}>
      <p className="text-sm text-gray-600 mb-3">最近搜尋:</p>
      <div className="flex flex-wrap gap-2">
        {history.map((address, index) => (
          <button
            key={address}
            onClick={() => onSelect(address)}
            disabled={isLoading}
            className="
              bg-gray-100 hover:bg-gray-200 
              disabled:bg-gray-50 disabled:cursor-not-allowed
              text-gray-700 disabled:text-gray-400
              px-3 py-1 rounded-full text-xs font-mono
              transition-colors duration-200
              flex items-center gap-2
            "
          >
            <span className="text-gray-400">#{index + 1}</span>
            {address.slice(0, 6)}...{address.slice(-4)}
          </button>
        ))}
      </div>
    </div>
  );
}
```

### 🔄 優化載入和錯誤組件

更新 `LoadingSpinner.tsx`：

```typescript
interface LoadingSpinnerProps {
  message?: string;
  details?: string;
  className?: string;
}

export function LoadingSpinner({ 
  message = "載入中...", 
  details,
  className = "" 
}: LoadingSpinnerProps) {
  return (
    <div className={`bg-white rounded-2xl shadow-xl p-12 text-center ${className}`}>
      <div className="flex flex-col items-center gap-6">
        {/* 動畫載入器 */}
        <div className="relative">
          <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
          <div className="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin absolute top-2 left-2 animate-pulse"></div>
        </div>
        
        <div className="space-y-2">
          <h3 className="text-lg font-semibold text-gray-700">
            {message}
          </h3>
          {details && (
            <p className="text-gray-500 text-sm max-w-md">
              {details}
            </p>
          )}
        </div>

        {/* 進度指示器 */}
        <div className="w-64 bg-gray-200 rounded-full h-2">
          <div className="bg-gradient-to-r from-blue-600 to-purple-600 h-2 rounded-full animate-pulse" style={{width: '60%'}}></div>
        </div>
      </div>
    </div>
  );
}
```

### 🧪 新增偵錯工具

建立偵錯組件 `app/rich-list/_components/DebugPanel.tsx`：

```typescript
import { useState } from 'react';
import { TokenData, TokenHolder } from '~~/hooks/useTokenHolders';

interface DebugPanelProps {
  tokenData: TokenData | null;
  holders: TokenHolder[];
  isLoading: boolean;
  error: string | null;
}

export function DebugPanel({ tokenData, holders, isLoading, error }: DebugPanelProps) {
  const [isOpen, setIsOpen] = useState(false);

  // 只在開發環境顯示
  if (process.env.NODE_ENV !== 'development') {
    return null;
  }

  return (
    <div className="fixed bottom-4 right-4 z-50">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="bg-gray-800 text-white p-2 rounded-full shadow-lg hover:bg-gray-700"
      >
        🔧
      </button>
      
      {isOpen && (
        <div className="absolute bottom-12 right-0 w-80 bg-white rounded-lg shadow-xl border p-4 max-h-96 overflow-y-auto">
          <h3 className="font-bold text-gray-800 mb-3">Debug Panel</h3>
          
          <div className="space-y-3 text-sm">
            <div>
              <strong>Loading:</strong> {isLoading ? '✅' : '❌'}
            </div>
            
            <div>
              <strong>Error:</strong> {error || '無'}
            </div>
            
            <div>
              <strong>Token Data:</strong> {tokenData ? '✅' : '❌'}
              {tokenData && (
                <div className="ml-2 text-xs text-gray-600">
                  <div>Name: {tokenData.name}</div>
                  <div>Symbol: {tokenData.symbol}</div>
                  <div>Decimals: {tokenData.decimals}</div>
                </div>
              )}
            </div>
            
            <div>
              <strong>Holders Count:</strong> {holders.length}
            </div>
            
            {holders.length > 0 && (
              <div>
                <strong>Top Holder:</strong>
                <div className="ml-2 text-xs text-gray-600 font-mono">
                  {holders[0].address.slice(0, 10)}...
                </div>
                <div className="ml-2 text-xs text-gray-600">
                  Balance: {holders[0].balanceFormatted}
                </div>
              </div>
            )}
            
            <div>
              <strong>Cache Stats:</strong>
              <button
                onClick={() => {
                  // 這裡可以添加清除快取的邏輯
                  console.log('Cache cleared');
                }}
                className="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded"
              >
                Clear Cache
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

### 🎨 優化用戶體驗

#### 1. 添加鍵盤快捷鍵支援

```typescript
// 在主頁面組件中添加
useEffect(() => {
  const handleKeyDown = (event: KeyboardEvent) => {
    // Ctrl/Cmd + Enter 執行搜尋
    if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
      if (tokenAddress && !isLoading) {
        handleSearch();
      }
    }
    
    // Escape 清除數據
    if (event.key === 'Escape') {
      clearData();
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [tokenAddress, isLoading, handleSearch, clearData]);
```

#### 2. 添加複製功能

```typescript
const copyToClipboard = async (text: string) => {
  try {
    await navigator.clipboard.writeText(text);
    // 顯示成功提示
    alert('已複製到剪貼簿');
  } catch (error) {
    console.error('複製失敗:', error);
  }
};
```

#### 3. 添加分享功能

```typescript
const shareResults = async () => {
  if (!tokenData) return;
  
  const shareData = {
    title: `${tokenData.name} (${tokenData.symbol}) 富豪榜`,
    text: `查看 ${tokenData.name} 代幣的持有者排行榜，共有 ${totalHolders} 個持有者。`,
    url: `${window.location.origin}/rich-list?token=${tokenData.contractAddress}`,
  };

  try {
    if (navigator.share) {
      await navigator.share(shareData);
    } else {
      // 備用方案：複製連結
      await copyToClipboard(shareData.url);
    }
  } catch (error) {
    console.error('分享失敗:', error);
  }
};
```

### ✅ 小結

在這一課中，我們成功將 API 整合到前端頁面：

✅ **安全的 API 架構**
- 建立 Next.js API 路由保護 API Key
- 實作錯誤處理和輸入驗證
- 友善的錯誤訊息轉換

✅ **完整的前端整合**
- 更新 Hook 使用新的 API 路由
- 優化頁面組件和用戶體驗
- 添加搜尋歷史和統計資訊

✅ **增強的用戶體驗**
- 載入動畫和狀態反饋
- 鍵盤快捷鍵支援
- 偵錯工具和錯誤處理

✅ **性能優化**
- 智能快取機制
- 分頁數據處理
- 請求防抖和節流

在下個單元中，我們將實作進階的分頁功能，讓用戶能夠更好地瀏覽大量的持有者數據！

---

**準備好實作更強大的分頁功能了嗎？** 📄
