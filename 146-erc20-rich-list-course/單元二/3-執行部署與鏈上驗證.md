# 第三課：執行部署與鏈上驗證

### 🎯 學習目標

在這一課中，我們將：
- 執行實際的合約部署到 Optimism Sepolia
- 在區塊鏈瀏覽器上驗證合約
- 測試合約功能並生成測試數據
- 學習部署後的最佳實踐

### 🚀 執行部署流程

#### 步驟 1：部署前最終檢查

在開始部署之前，讓我們做最後的檢查：

```bash
cd packages/hardhat

# 1. 檢查環境變數
echo "檢查環境變數..."
if [ -z "$DEPLOYER_PRIVATE_KEY" ]; then
  echo "❌ DEPLOYER_PRIVATE_KEY 未設定"
  exit 1
fi

if [ -z "$ALCHEMY_API_KEY" ]; then
  echo "❌ ALCHEMY_API_KEY 未設定"
  exit 1
fi

echo "✅ 環境變數檢查完成"

# 2. 檢查錢包餘額
npx hardhat run scripts/check-balance.ts --network optimismSepolia
```

建立檢查餘額腳本 `scripts/check-balance.ts`：

```typescript
import { ethers } from "hardhat";

async function checkBalance() {
  const [deployer] = await ethers.getSigners();
  const balance = await ethers.provider.getBalance(deployer.address);
  const network = await ethers.provider.getNetwork();
  
  console.log("💰 錢包餘額檢查:");
  console.log(`   地址: ${deployer.address}`);
  console.log(`   網路: ${network.name} (${network.chainId})`);
  console.log(`   餘額: ${ethers.formatEther(balance)} ETH`);
  
  const minimumBalance = ethers.parseEther("0.01");
  if (balance < minimumBalance) {
    console.log("❌ 餘額不足，需要至少 0.01 ETH 進行部署");
    console.log("🔗 獲取測試 ETH: https://faucet.quicknode.com/optimism/sepolia");
    process.exit(1);
  }
  
  console.log("✅ 餘額充足，可以進行部署");
}

checkBalance()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

#### 步驟 2：執行部署

```bash
# 清理之前的部署（如果有）
rm -rf deployments/optimismSepolia/

# 編譯合約
yarn compile

# 執行測試
yarn test

# 部署到 Optimism Sepolia
yarn deploy --network optimismSepolia
```

**預期輸出：**
```
==================================================
🚀 開始部署 RichListToken 合約
==================================================
📊 部署參數:
   網路: optimismSepolia
   部署者: 0x742d35Cc6634C0532925a3b8D238C1e8D8F6D9E8
   代幣擁有者: 0x742d35Cc6634C0532925a3b8D238C1e8D8F6D9E8
   代幣名稱: RichList Demo Token
   代幣符號: RDT
   初始供應量: 1000000 tokens

✅ 部署者餘額檢查通過: 0.05 ETH
📦 正在部署 RichListToken 合約...
deploying "RichListToken" (tx: 0x1234567890abcdef...)
waiting for 5 block confirmations...
✅ 合約部署成功!
   合約地址: 0xAbC123456789dEf...
   部署交易: 0x1234567890abcdef...
   Gas 使用量: 2,345,678

🔍 驗證部署結果...
   代幣名稱: RichList Demo Token
   代幣符號: RDT
   小數點位數: 18
   總供應量: 1000000.0 tokens
   最大供應量: 100000000.0 tokens
   合約擁有者: 0x742d35Cc6634C0532925a3b8D238C1e8D8F6D9E8
   擁有者餘額: 1000000.0 tokens

==================================================
🎉 RichListToken 部署完成!
==================================================
🔗 在區塊鏈瀏覽器中查看: https://sepolia-optimism.etherscan.io/address/0xAbC123456789dEf...
```

#### 步驟 3：驗證部署成功

```bash
# 執行部署驗證腳本
npx hardhat run scripts/verify-deployment.ts --network optimismSepolia
```

### 🔍 區塊鏈瀏覽器驗證

#### 步驟 1：自動合約驗證

```bash
# 使用 Hardhat 自動驗證合約
npx hardhat verify --network optimismSepolia <CONTRACT_ADDRESS> "RichList Demo Token" "RDT" "1000000" "<OWNER_ADDRESS>"

# 例如:
npx hardhat verify --network optimismSepolia 0xAbC123456789dEf... "RichList Demo Token" "RDT" "1000000" "0x742d35Cc6634C0532925a3b8D238C1e8D8F6D9E8"
```

#### 步驟 2：手動驗證（如果自動驗證失敗）

1. **前往 Optimism Sepolia Etherscan**
   - 打開 https://sepolia-optimism.etherscan.io
   - 搜索你的合約地址

2. **點擊 "Contract" 標籤**
   - 選擇 "Verify and Publish"

3. **填寫驗證資訊**
   ```
   Compiler Type: Solidity (Single file)
   Compiler Version: v0.8.19+commit.7dd6d404
   Open Source License Type: MIT
   ```

4. **貼上合約原始碼**
   - 複製完整的 `RichListToken.sol` 內容
   - 包含所有 import 的合約

5. **填寫建構子參數**
   ```
   RichList Demo Token
   RDT
   1000000
   0x742d35Cc6634C0532925a3b8D238C1e8D8F6D9E8
   ```

#### 步驟 3：驗證成功確認

驗證成功後，你應該能看到：
- ✅ 綠色的勾選標記
- 📋 完整的合約原始碼
- 🔍 可讀的合約函數介面
- 📊 合約事件日誌

### 🧪 測試合約功能

#### 步驟 1：基本功能測試

建立測試腳本 `scripts/test-contract-functions.ts`：

```typescript
import { ethers } from "hardhat";
import { RichListToken } from "../typechain-types";

async function testContractFunctions() {
  console.log("🧪 開始測試合約功能...");
  
  // 獲取合約實例
  const deployment = await ethers.deployments.get("RichListToken");
  const richListToken = await ethers.getContractAt("RichListToken", deployment.address) as RichListToken;
  const [deployer] = await ethers.getSigners();
  
  console.log(`📋 合約地址: ${deployment.address}`);
  console.log(`👤 測試者: ${deployer.address}`);
  
  try {
    // 測試 1: 讀取基本資訊
    console.log("\n📊 測試 1: 讀取基本資訊");
    const [name, symbol, decimals, totalSupply, maxSupply] = await richListToken.getTokenInfo();
    console.log(`   ✅ 名稱: ${name}`);
    console.log(`   ✅ 符號: ${symbol}`);
    console.log(`   ✅ 小數位: ${decimals}`);
    console.log(`   ✅ 總供應: ${ethers.formatEther(totalSupply)}`);
    console.log(`   ✅ 最大供應: ${ethers.formatEther(maxSupply)}`);
    
    // 測試 2: 檢查擁有者餘額
    console.log("\n💰 測試 2: 檢查餘額");
    const ownerBalance = await richListToken.balanceOf(deployer.address);
    console.log(`   ✅ 擁有者餘額: ${ethers.formatEther(ownerBalance)} tokens`);
    
    // 測試 3: 測試鑄造功能
    console.log("\n🏭 測試 3: 鑄造功能");
    const mintAmount = ethers.parseEther("1000");
    const testAddress = "0x1234567890123456789012345678901234567890";
    
    console.log(`   鑄造 ${ethers.formatEther(mintAmount)} tokens 到 ${testAddress}...`);
    const mintTx = await richListToken.mint(testAddress, mintAmount);
    await mintTx.wait();
    
    const testBalance = await richListToken.balanceOf(testAddress);
    console.log(`   ✅ 鑄造成功，餘額: ${ethers.formatEther(testBalance)} tokens`);
    
    // 測試 4: 測試轉帳功能
    console.log("\n💸 測試 4: 轉帳功能");
    const transferAmount = ethers.parseEther("500");
    const recipient = "0x9876543210987654321098765432109876543210";
    
    console.log(`   轉帳 ${ethers.formatEther(transferAmount)} tokens 到 ${recipient}...`);
    const transferTx = await richListToken.transfer(recipient, transferAmount);
    await transferTx.wait();
    
    const recipientBalance = await richListToken.balanceOf(recipient);
    console.log(`   ✅ 轉帳成功，接收者餘額: ${ethers.formatEther(recipientBalance)} tokens`);
    
    // 測試 5: 測試批量轉帳
    console.log("\n📦 測試 5: 批量轉帳");
    const recipients = [
      "0x1111111111111111111111111111111111111111",
      "0x2222222222222222222222222222222222222222",
      "0x3333333333333333333333333333333333333333"
    ];
    const amounts = [
      ethers.parseEther("100"),
      ethers.parseEther("200"),
      ethers.parseEther("300")
    ];
    
    console.log(`   批量轉帳到 ${recipients.length} 個地址...`);
    const batchTx = await richListToken.batchTransfer(recipients, amounts);
    await batchTx.wait();
    
    for (let i = 0; i < recipients.length; i++) {
      const balance = await richListToken.balanceOf(recipients[i]);
      console.log(`   ✅ ${recipients[i]}: ${ethers.formatEther(balance)} tokens`);
    }
    
    console.log("\n🎉 所有功能測試通過!");
    
  } catch (error) {
    console.error("❌ 測試失敗:", error);
  }
}

testContractFunctions()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

執行測試：

```bash
npx hardhat run scripts/test-contract-functions.ts --network optimismSepolia
```

#### 步驟 2：生成富豪榜測試數據

```bash
# 生成測試數據
npx hardhat run scripts/generate-test-data.ts --network optimismSepolia
```

**預期輸出：**
```
🎲 開始生成測試數據...
📝 使用帳戶: 0x742d35Cc6634C0532925a3b8D238C1e8D8F6D9E8
💰 部署者代幣餘額: 999400.0 tokens
📊 準備分發代幣給 30 個地址
💸 總分發金額: 181000 tokens
📦 處理第 1 批 (10 個地址)...
   交易哈希: 0xabcd1234...
   ✅ 批次完成
📦 處理第 2 批 (10 個地址)...
   交易哈希: 0xefgh5678...
   ✅ 批次完成
📦 處理第 3 批 (10 個地址)...
   交易哈希: 0xijkl9012...
   ✅ 批次完成
🎉 測試數據生成完成!

📈 富豪榜預覽 (前 10 名):
   1. 0x742d35Cc6634C0532925a3b8D238C1e8D8F6D9E8: 50000.0 tokens
   2. 0x8ba1f109551bD432803012645Hac136c22C8C7c: 30000.0 tokens
   3. 0xaB7C8803962c0f2F5BBBe3FA8bf41cd82d1b2B: 25000.0 tokens
   4. 0x4B20993Bc481177ec7E8f571ceCaE8A9e22C02db: 20000.0 tokens
   5. 0x78731D3Ca6b7E34aC0F824c42a7cC18A495cabaB: 15000.0 tokens
   ...
```

### 📊 驗證部署資訊

#### 步驟 1：檢查部署檔案

```bash
# 查看部署資訊
cat deployments/optimismSepolia/RichListToken.json | jq '.address'
cat deployments/optimismSepolia/RichListToken.json | jq '.transactionHash'
cat deployments/optimismSepolia/RichListToken.json | jq '.receipt.gasUsed'
```

#### 步驟 2：更新前端配置

部署成功後，需要更新前端的合約配置：

```bash
# 複製部署資訊到前端
cp deployments/optimismSepolia/RichListToken.json ../nextjs/contracts/deployedContracts.ts
```

或手動更新 `packages/nextjs/contracts/deployedContracts.ts`：

```typescript
const deployedContracts = {
  11155420: { // Optimism Sepolia Chain ID
    RichListToken: {
      address: "0xYourContractAddress",
      abi: [
        // ... ABI from deployment
      ],
    },
  },
} as const;

export default deployedContracts;
```

### 🔗 重要連結整理

部署完成後，整理重要連結：

#### 區塊鏈瀏覽器
- **合約地址**: https://sepolia-optimism.etherscan.io/address/[CONTRACT_ADDRESS]
- **部署交易**: https://sepolia-optimism.etherscan.io/tx/[DEPLOY_TX_HASH]
- **代幣頁面**: https://sepolia-optimism.etherscan.io/token/[CONTRACT_ADDRESS]

#### 開發工具
- **Alchemy Dashboard**: https://dashboard.alchemy.com/
- **Optimism Sepolia Faucet**: https://faucet.quicknode.com/optimism/sepolia
- **Optimism Bridge**: https://app.optimism.io/bridge

### 📋 部署後檢查清單

確認以下項目都已完成：

- [ ] **合約部署成功**
  - 部署交易已確認
  - 合約地址可訪問
  - Gas 費用合理

- [ ] **合約驗證完成**
  - 原始碼已驗證
  - 建構子參數正確
  - 函數介面可讀

- [ ] **功能測試通過**
  - 基本 ERC20 功能正常
  - 鑄造功能正常
  - 批量操作正常

- [ ] **測試數據生成**
  - 富豪榜數據已建立
  - 多個持有者地址
  - 餘額分布合理

- [ ] **前端配置更新**
  - 合約地址已更新
  - ABI 已同步
  - 網路配置正確

### 🐛 常見問題排除

#### 問題 1：驗證失敗

```
Error: Unable to verify contract
```

**解決方案：**
1. 檢查編譯器版本是否匹配
2. 確認建構子參數格式正確
3. 使用 flattened 合約代碼
4. 等待幾分鐘後重試

#### 問題 2：Gas 估算錯誤

```
Error: cannot estimate gas
```

**解決方案：**
1. 檢查函數參數是否正確
2. 確認錢包有足夠餘額
3. 增加 gas limit
4. 檢查合約邏輯錯誤

#### 問題 3：交易失敗

```
Error: transaction reverted
```

**解決方案：**
1. 查看 revert 原因
2. 檢查權限設定
3. 驗證輸入參數
4. 測試網路連接

### 🎉 恭喜！

你已經成功完成了 ERC20 代幣的完整部署流程！現在你擁有：

✅ **已部署的 ERC20 代幣**
- 在 Optimism Sepolia 上運行
- 經過區塊鏈瀏覽器驗證
- 具備完整功能

✅ **豐富的測試數據**
- 多個代幣持有者
- 不同餘額分布
- 富豪榜排行數據

✅ **完整的部署文檔**
- 部署交易記錄
- 合約地址和 ABI
- 測試結果驗證

在下個單元中，我們將開始建立前端應用，讓用戶能夠查詢和展示這些富豪榜數據！

---

**準備好建立美觀的前端界面了嗎？** 🎨
