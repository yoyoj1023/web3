# ç¬¬ä¸€èª²ï¼šç•™è¨€æ¿åˆç´„çš„è³‡æ–™çµæ§‹è¨­è¨ˆ

## ðŸŽ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬èª²å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š
- ç†è§£ä¸åŒè³‡æ–™çµæ§‹è¨­è¨ˆæ–¹æ¡ˆçš„å„ªç¼ºé»ž
- å­¸æœƒæ ¹æ“šæ‡‰ç”¨å ´æ™¯è¨­è¨ˆæœ€å„ªçš„åˆç´„è³‡æ–™çµæ§‹
- æŽŒæ¡ Solidity ä¸­ structã€arrayã€mapping çš„æœ€ä½³å¯¦è¸
- ç‚ºå¯æ“´å±•çš„ DApp å¥ å®šå …å¯¦çš„åˆç´„åŸºç¤Ž

## ðŸ“‹ èª²ç¨‹å¤§ç¶±

1. [ç°¡å–®æ–¹æ¡ˆ vs çµæ§‹åŒ–æ–¹æ¡ˆ](#ç°¡å–®æ–¹æ¡ˆ-vs-çµæ§‹åŒ–æ–¹æ¡ˆ)
2. [è³‡æ–™çµæ§‹è¨­è¨ˆåŽŸå‰‡](#è³‡æ–™çµæ§‹è¨­è¨ˆåŽŸå‰‡)
3. [Message Struct è¨­è¨ˆè©³è§£](#message-struct-è¨­è¨ˆè©³è§£)
4. [Gas å„ªåŒ–è€ƒé‡](#gas-å„ªåŒ–è€ƒé‡)
5. [å¯æ“´å±•æ€§è¨­è¨ˆ](#å¯æ“´å±•æ€§è¨­è¨ˆ)

---

## ç°¡å–®æ–¹æ¡ˆ vs çµæ§‹åŒ–æ–¹æ¡ˆ

### ðŸ”¸ æ–¹æ¡ˆä¸€ï¼šç°¡å–®å­—ä¸²é™£åˆ—

```solidity
contract SimpleMessageBoard {
    string[] public messages;
    
    function postMessage(string memory _message) public {
        messages.push(_message);
    }
    
    function getAllMessages() public view returns (string[] memory) {
        return messages;
    }
}
```

**å„ªé»žï¼š**
- ç¨‹å¼ç¢¼ç°¡æ½”
- å¯¦ä½œå¿«é€Ÿ
- æ¦‚å¿µç›´è§€

**ç¼ºé»žï¼š**
- ç„¡æ³•çŸ¥é“æ˜¯èª°ç™¼é€çš„ç•™è¨€
- ç„¡æ³•è¨˜éŒ„ç•™è¨€æ™‚é–“
- é›£ä»¥å¯¦ç¾é€²éšŽåŠŸèƒ½ï¼ˆå¦‚ç•™è¨€å›žè¦†ã€æŒ‰è®šç­‰ï¼‰
- ä¸åˆ©æ–¼æœªä¾†æ“´å±•

### ðŸ”¸ æ–¹æ¡ˆäºŒï¼šçµæ§‹åŒ–è¨­è¨ˆ

```solidity
contract StructuredMessageBoard {
    struct Message {
        address sender;        // ç™¼é€è€…åœ°å€
        uint256 timestamp;     // ç™¼é€æ™‚é–“æˆ³
        string ipfsCid;       // IPFS å…§å®¹è­˜åˆ¥ç¢¼
        uint256 likes;        // æŒ‰è®šæ•¸é‡ï¼ˆå¯é¸ï¼‰
        bool isActive;        // è¨Šæ¯ç‹€æ…‹ï¼ˆå¯é¸ï¼‰
    }
    
    Message[] public messages;
    
    function postMessage(string memory _ipfsCid) public {
        Message memory newMessage = Message({
            sender: msg.sender,
            timestamp: block.timestamp,
            ipfsCid: _ipfsCid,
            likes: 0,
            isActive: true
        });
        
        messages.push(newMessage);
    }
    
    function getAllMessages() public view returns (Message[] memory) {
        return messages;
    }
}
```

**å„ªé»žï¼š**
- è±å¯Œçš„éˆä¸Šè³‡æ–™
- æ”¯æ´è¤‡é›œåŠŸèƒ½å¯¦ç¾
- è‰¯å¥½çš„å¯æ“´å±•æ€§
- ä¾¿æ–¼å‰ç«¯è™•ç†å’Œå±•ç¤º

**ç¼ºé»žï¼š**
- ç¨‹å¼ç¢¼ç¨å¾®è¤‡é›œ
- Gas æ¶ˆè€—ç•¥é«˜ï¼ˆä½†å·®ç•°å¾ˆå°ï¼‰

---

## è³‡æ–™çµæ§‹è¨­è¨ˆåŽŸå‰‡

### ðŸŽ¯ **åŽŸå‰‡ä¸€ï¼šæœ€å°å¤ ç”¨åŽŸå‰‡**

åªåœ¨éˆä¸Šå„²å­˜å¿…è¦çš„è³‡æ–™ï¼Œé¿å…ä¸å¿…è¦çš„ Gas æ¶ˆè€—ï¼š

```solidity
// âŒ éŽåº¦è¨­è¨ˆ
struct Message {
    address sender;
    uint256 timestamp;
    string ipfsCid;
    string title;           // æ‡‰è©²æ”¾åœ¨ IPFS ä¸­
    string content;         // æ‡‰è©²æ”¾åœ¨ IPFS ä¸­
    string authorName;      // æ‡‰è©²æ”¾åœ¨ IPFS ä¸­
    string[] tags;          // æ‡‰è©²æ”¾åœ¨ IPFS ä¸­
}

// âœ… ç²¾ç°¡è¨­è¨ˆ
struct Message {
    address sender;         // éˆä¸Šé©—è­‰éœ€è¦
    uint256 timestamp;      // éˆä¸ŠæŽ’åºéœ€è¦
    string ipfsCid;        // é€£çµ IPFS å…§å®¹
}
```

### ðŸŽ¯ **åŽŸå‰‡äºŒï¼šæœªä¾†æ“´å±•è€ƒé‡**

è¨­è¨ˆæ™‚è€ƒæ…®æœªä¾†å¯èƒ½çš„åŠŸèƒ½éœ€æ±‚ï¼š

```solidity
// âœ… å…·æœ‰æ“´å±•æ€§çš„è¨­è¨ˆ
struct Message {
    address sender;
    uint256 timestamp;
    string ipfsCid;
    uint256 likes;          // æœªä¾†å¯å¯¦ç¾æŒ‰è®šåŠŸèƒ½
    uint256 replies;        // æœªä¾†å¯å¯¦ç¾å›žè¦†è¨ˆæ•¸
    bool isActive;          // æœªä¾†å¯å¯¦ç¾è¨Šæ¯ç‹€æ…‹ç®¡ç†
}
```

### ðŸŽ¯ **åŽŸå‰‡ä¸‰ï¼šGas æ•ˆçŽ‡å„ªåŒ–**

åˆç†å®‰æŽ’ struct æˆå“¡é †åºï¼Œåˆ©ç”¨ Storage Packingï¼š

```solidity
// âŒ æœªå„ªåŒ–çš„é †åº
struct Message {
    bool isActive;      // 1 byte
    address sender;     // 20 bytes  -> æ–°çš„ slot
    uint256 timestamp;  // 32 bytes  -> æ–°çš„ slot
    string ipfsCid;     // dynamic   -> æ–°çš„ slot
}
// ç¸½å…±ä½¿ç”¨ 4 å€‹ storage slots

// âœ… å„ªåŒ–å¾Œçš„é †åº  
struct Message {
    address sender;     // 20 bytes
    bool isActive;      // 1 byte    -> åŒä¸€å€‹ slot
    uint256 timestamp;  // 32 bytes  -> æ–°çš„ slot
    string ipfsCid;     // dynamic   -> æ–°çš„ slot
}
// ç¸½å…±ä½¿ç”¨ 3 å€‹ storage slotsï¼Œç¯€çœ Gas
```

---

## Message Struct è¨­è¨ˆè©³è§£

### ðŸ—ï¸ æ ¸å¿ƒç‰ˆæœ¬ï¼ˆæŽ¨è–¦ç”¨æ–¼èª²ç¨‹ï¼‰

```solidity
struct Message {
    address sender;        // ç™¼é€è€…åœ°å€
    uint256 timestamp;     // ç™¼é€æ™‚é–“æˆ³
    string ipfsCid;       // IPFS å…§å®¹è­˜åˆ¥ç¢¼
}
```

**å„æ¬„ä½èªªæ˜Žï¼š**

#### **`address sender`**
- **ç”¨é€”**ï¼šè¨˜éŒ„ç•™è¨€ç™¼é€è€…
- **ç‚ºä»€éº¼éœ€è¦**ï¼š
  - å‰ç«¯å¯ä»¥é¡¯ç¤ºã€Œç”± 0x1234... ç™¼é€ã€
  - å¯ä»¥å¯¦ç¾ä½¿ç”¨è€…å€‹äººé é¢
  - ç‚ºæœªä¾†çš„æ¬Šé™æŽ§åˆ¶åŠŸèƒ½æ‰“åŸºç¤Ž

#### **`uint256 timestamp`**
- **ç”¨é€”**ï¼šè¨˜éŒ„ç•™è¨€ç™¼é€æ™‚é–“
- **ç‚ºä»€éº¼éœ€è¦**ï¼š
  - å‰ç«¯å¯ä»¥é¡¯ç¤ºã€Œç™¼é€æ–¼ 2023/12/25 10:30ã€
  - å¯ä»¥æŒ‰æ™‚é–“æŽ’åºç•™è¨€
  - ç‚ºæœªä¾†çš„æ™‚é–“ç¯„åœæŸ¥è©¢æ‰“åŸºç¤Ž

#### **`string ipfsCid`**
- **ç”¨é€”**ï¼šé€£çµåˆ° IPFS å„²å­˜çš„å¯¦éš›å…§å®¹
- **ç‚ºä»€éº¼ç”¨ string**ï¼š
  - CID çš„é•·åº¦å¯èƒ½è®ŠåŒ–ï¼ˆä¸åŒçš„é›œæ¹Šæ¼”ç®—æ³•ï¼‰
  - ä¾¿æ–¼å‰ç«¯è™•ç†
  - æ”¯æ´æœªä¾†çš„ CID æ ¼å¼å‡ç´š

### ðŸ”§ æ“´å±•ç‰ˆæœ¬ï¼ˆé©åˆé€²éšŽéœ€æ±‚ï¼‰

```solidity
struct Message {
    address sender;
    uint256 timestamp;
    string ipfsCid;
    uint256 likes;         // æŒ‰è®šæ•¸é‡
    uint256 replyCount;    // å›žè¦†æ•¸é‡
    bool isActive;         // è¨Šæ¯æ˜¯å¦å•Ÿç”¨
    uint256 messageId;     // è¨Šæ¯å”¯ä¸€ ID
}
```

---

## Gas å„ªåŒ–è€ƒé‡

### â›½ **Storage vs Memory vs Calldata**

```solidity
// âœ… æ­£ç¢ºçš„åƒæ•¸ä½¿ç”¨
function postMessage(string calldata _ipfsCid) public {
    // ä½¿ç”¨ calldata ç¯€çœ Gasï¼ˆå¤–éƒ¨å‘¼å«æ™‚ï¼‰
}

function getAllMessages() public view returns (Message[] memory) {
    // è¿”å›žæ™‚ä½¿ç”¨ memory
}

// âœ… å…§éƒ¨è™•ç†å„ªåŒ–
function postMessage(string calldata _ipfsCid) public {
    Message memory newMessage = Message({
        sender: msg.sender,
        timestamp: block.timestamp,
        ipfsCid: _ipfsCid
    });
    // å…ˆåœ¨ memory ä¸­æ§‹å»ºï¼Œå†ä¸€æ¬¡æ€§å¯«å…¥ storage
    messages.push(newMessage);
}
```

### â›½ **äº‹ä»¶ä½¿ç”¨å„ªåŒ–**

å–„ç”¨äº‹ä»¶ä¾†æ¸›å°‘ Storage è®€å–ï¼š

```solidity
event MessagePosted(
    uint256 indexed messageId,
    address indexed sender,
    uint256 timestamp,
    string ipfsCid
);

function postMessage(string calldata _ipfsCid) public {
    uint256 messageId = messages.length;
    
    Message memory newMessage = Message({
        sender: msg.sender,
        timestamp: block.timestamp,
        ipfsCid: _ipfsCid
    });
    
    messages.push(newMessage);
    
    // ç™¼å‡ºäº‹ä»¶ï¼Œå‰ç«¯å¯ä»¥ç›£è½è€Œä¸éœ€è¦è¼ªè©¢
    emit MessagePosted(messageId, msg.sender, block.timestamp, _ipfsCid);
}
```

---

## å¯æ“´å±•æ€§è¨­è¨ˆ

### ðŸš€ **æ”¯æ´å›žè¦†åŠŸèƒ½çš„è¨­è¨ˆ**

```solidity
struct Message {
    address sender;
    uint256 timestamp;
    string ipfsCid;
    uint256 replyToId;     // å›žè¦†å“ªä¸€å‰‡è¨Šæ¯ï¼ˆ0 è¡¨ç¤ºåŽŸå§‹ç•™è¨€ï¼‰
    uint256[] replies;     // æ­¤è¨Šæ¯çš„å›žè¦†åˆ—è¡¨
}
```

### ðŸš€ **æ”¯æ´ä½¿ç”¨è€…è³‡æ–™çš„è¨­è¨ˆ**

```solidity
struct UserProfile {
    string profileCid;     // ä½¿ç”¨è€…è³‡æ–™çš„ IPFS CID
    uint256 messageCount;  // ç™¼é€çš„è¨Šæ¯æ•¸é‡
    bool isVerified;       // æ˜¯å¦ç‚ºé©—è­‰ä½¿ç”¨è€…
}

mapping(address => UserProfile) public userProfiles;
```

### ðŸš€ **æ”¯æ´ç•™è¨€åˆ†é¡žçš„è¨­è¨ˆ**

```solidity
struct Message {
    address sender;
    uint256 timestamp;
    string ipfsCid;
    uint256 categoryId;    // ç•™è¨€åˆ†é¡ž
}

struct Category {
    string name;
    string description;
    bool isActive;
}

Category[] public categories;
```

---

## ðŸ’¡ å¯¦ä½œå»ºè­°

### **éšŽæ®µå¼é–‹ç™¼ç­–ç•¥**

1. **ç¬¬ä¸€éšŽæ®µ**ï¼šå¯¦ä½œæ ¸å¿ƒç‰ˆæœ¬
   ```solidity
   struct Message {
       address sender;
       uint256 timestamp;
       string ipfsCid;
   }
   ```

2. **ç¬¬äºŒéšŽæ®µ**ï¼šæ ¹æ“šéœ€æ±‚æ·»åŠ åŠŸèƒ½
   ```solidity
   struct Message {
       address sender;
       uint256 timestamp;
       string ipfsCid;
       uint256 likes;     // æ·»åŠ æŒ‰è®šåŠŸèƒ½
   }
   ```

3. **ç¬¬ä¸‰éšŽæ®µ**ï¼šå¯¦ç¾è¤‡é›œåŠŸèƒ½
   ```solidity
   // æ·»åŠ å›žè¦†ã€åˆ†é¡žç­‰é€²éšŽåŠŸèƒ½
   ```

### **è³‡æ–™é©—è­‰ç­–ç•¥**

```solidity
// âœ… æ·»åŠ å¿…è¦çš„é©—è­‰
function postMessage(string calldata _ipfsCid) public {
    require(bytes(_ipfsCid).length > 0, "CID cannot be empty");
    require(bytes(_ipfsCid).length < 100, "CID too long");
    
    // å¯é¸ï¼šé©—è­‰ CID æ ¼å¼
    require(isValidCid(_ipfsCid), "Invalid CID format");
    
    // ... å…¶é¤˜é‚è¼¯
}
```

---

## ðŸ“ æœ¬èª²ç¸½çµ

### **é—œéµè¦é»ž**

1. **çµæ§‹åŒ–è¨­è¨ˆå„ªæ–¼ç°¡å–®è¨­è¨ˆ**ï¼šé›–ç„¶è¤‡é›œåº¦ç•¥å¢žï¼Œä½†å¯æ“´å±•æ€§å¤§å¹…æå‡
2. **æœ€å°å¤ ç”¨åŽŸå‰‡**ï¼šåªåœ¨éˆä¸Šå„²å­˜å¿…è¦è³‡æ–™ï¼Œå…¶é¤˜æ”¾åœ¨ IPFS
3. **Gas å„ªåŒ–**ï¼šåˆç†å®‰æŽ’ struct é †åºï¼Œå–„ç”¨ events
4. **æœªä¾†è¦åŠƒ**ï¼šè¨­è¨ˆæ™‚è€ƒæ…®å¯èƒ½çš„åŠŸèƒ½æ“´å±•

### **ä¸‹ä¸€èª²é å‘Š**

åœ¨ä¸‹ä¸€èª²ä¸­ï¼Œæˆ‘å€‘å°‡æŠŠé€™å€‹è¨­è¨ˆå¯¦éš›å¯¦ä½œå‡ºä¾†ï¼Œåœ¨ Scaffold-eth-2 å°ˆæ¡ˆä¸­æ’°å¯«å®Œæ•´çš„ `MessageBoard.sol` åˆç´„ï¼

---

## ðŸ”— å»¶ä¼¸é–±è®€

- [Solidity Storage Layout](https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html)
- [Gas å„ªåŒ–æœ€ä½³å¯¦è¸](https://github.com/iskdrews/awesome-solidity-gas-optimization)
- [Ethereum è³‡æ–™çµæ§‹è¨­è¨ˆæ¨¡å¼](https://soliditydeveloper.com/solidity-design-patterns)

**ä¸‹ä¸€èª²ï¼š** [ç¬¬äºŒèª²ï¼šã€å¯¦ä½œã€‘åœ¨ Scaffold-eth-2 ä¸­æ’°å¯«ç•™è¨€æ¿åˆç´„](ç¬¬äºŒèª²-åœ¨Scaffold-eth-2ä¸­æ’°å¯«ç•™è¨€æ¿åˆç´„.md)
