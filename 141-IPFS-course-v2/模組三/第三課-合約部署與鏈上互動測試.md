# 第三課：合約部署與鏈上互動測試

## 🎯 學習目標

完成本課後，您將能夠：
- 成功部署 MessageBoard 合約到本地開發網路
- 使用 Scaffold-eth-2 的 Debug Contracts 頁面測試合約功能
- 理解智能合約的部署流程和常見問題
- 掌握合約互動的最佳實踐

## 📋 課程大綱

1. [環境準備與啟動](#環境準備與啟動)
2. [合約部署流程](#合約部署流程)
3. [Debug Contracts 介面使用](#debug-contracts-介面使用)
4. [功能測試清單](#功能測試清單)
5. [常見問題與解決方案](#常見問題與解決方案)

---

## 環境準備與啟動

### 🚀 **步驟一：確認專案結構**

確保您的專案具有以下結構：

```
my-message-board/
├── packages/
│   ├── hardhat/
│   │   ├── contracts/
│   │   │   └── MessageBoard.sol    ←← 上一課建立的合約
│   │   ├── deploy/
│   │   │   └── 00_deploy_message_board.ts
│   │   └── hardhat.config.ts
│   └── nextjs/
└── package.json
```

### 🚀 **步驟二：啟動本地區塊鏈**

開啟第一個終端視窗，啟動本地 Hardhat 網路：

```bash
# 進入專案根目錄
cd my-message-board

# 啟動本地區塊鏈
yarn chain
```

您應該會看到類似的輸出：

```
Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/

Accounts
========

Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

Account #1: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 (10000 ETH)
Private Key: 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c6a8412f721fd8e
```

**⚠️ 保持此終端運行，不要關閉！**

### 🚀 **步驟三：啟動前端應用**

開啟第二個終端視窗，啟動前端：

```bash
# 在專案根目錄的新終端視窗
cd my-message-board

# 啟動前端
yarn start
```

等待編譯完成後，前端會在 `http://localhost:3000` 上運行。

---

## 合約部署流程

### 📦 **步驟一：編譯合約**

開啟第三個終端視窗進行部署：

```bash
# 在專案根目錄的新終端視窗
cd my-message-board

# 編譯合約
yarn compile
```

成功編譯後會看到：

```
Compiling 1 file with 0.8.19
Compilation finished successfully
```

### 📦 **步驟二：部署合約**

```bash
# 部署到本地網路
yarn deploy
```

成功部署後會看到：

```
deploying "MessageBoard" (tx: 0x...)...
deployed at 0x5FbDB2315678afecb367f032d93F642f64180aa3 with 2,845,947 gas
👋 MessageBoard deployed to: 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

### 📦 **步驟三：驗證部署**

檢查合約是否正確部署：

```bash
# 查看部署的合約資訊
yarn hardhat console --network localhost
```

在 console 中執行：

```javascript
// 獲取合約實例
const MessageBoard = await ethers.getContractFactory("MessageBoard");
const messageBoard = await MessageBoard.attach("0x5FbDB2315678afecb367f032d93F642f64180aa3");

// 檢查基本資訊
console.log("Contract address:", messageBoard.address);
console.log("Total messages:", await messageBoard.getTotalMessages());
console.log("Is paused:", await messageBoard.isPaused());

// 退出 console
.exit
```

---

## Debug Contracts 介面使用

### 🔧 **步驟一：存取 Debug Contracts 頁面**

1. 開啟瀏覽器，前往 `http://localhost:3000`
2. 點擊頂部導航列的 **"Debug Contracts"** 選項
3. 您應該會看到 `MessageBoard` 合約的互動介面

### 🔧 **步驟二：介面概覽**

Debug Contracts 頁面會顯示：

```
📋 MessageBoard Contract
├── 📖 Read Functions (查詢功能)
│   ├── getAllMessages
│   ├── getMessage
│   ├── getLatestMessages  
│   ├── getUserMessages
│   ├── getTotalMessages
│   ├── getUserMessageCount
│   ├── owner
│   ├── isPaused
│   └── messages (array access)
├── ✏️ Write Functions (寫入功能)
│   ├── postMessage
│   ├── setPaused
│   └── transferOwnership
└── 📅 Events (事件日誌)
    ├── MessagePosted
    └── BoardStatusChanged
```

### 🔧 **步驟三：介面操作說明**

#### **讀取功能（無需 Gas）**
- 點擊函式名稱即可執行
- 結果會即時顯示在下方
- 可以重複執行不會有額外成本

#### **寫入功能（需要 Gas）**
- 需要填入必要參數
- 點擊 "Send" 按鈕執行交易
- 需要等待交易確認（通常幾秒鐘）

#### **事件監聽**
- 在頁面底部可以看到事件日誌
- 每次寫入操作都會觸發對應事件

---

## 功能測試清單

### ✅ **測試一：初始狀態檢查**

**目標**：確認合約部署後的初始狀態正確

1. **檢查留言總數**
   - 點擊 `getTotalMessages`
   - **預期結果**：`0`

2. **檢查暫停狀態**
   - 點擊 `isPaused`
   - **預期結果**：`false`

3. **檢查擁有者**
   - 點擊 `owner`
   - **預期結果**：部署者地址（通常是 `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266`）

### ✅ **測試二：發布第一則留言**

**目標**：測試基本的留言發布功能

1. **發布留言**
   - 找到 `postMessage` 函式
   - 在 `_ipfsCid` 欄位輸入：`QmTestMessage1`
   - 點擊 "Send" 按鈕
   - **預期結果**：交易成功，顯示交易雜湊

2. **驗證留言發布**
   - 點擊 `getTotalMessages`
   - **預期結果**：`1`

3. **檢查事件**
   - 在頁面底部查看 Events 區域
   - **預期結果**：看到 `MessagePosted` 事件，包含正確的參數

### ✅ **測試三：讀取留言內容**

**目標**：測試各種留言讀取功能

1. **讀取所有留言**
   - 點擊 `getAllMessages`
   - **預期結果**：顯示陣列，包含一則留言，內容應該匹配我們剛才發布的

2. **讀取特定留言**
   - 在 `getMessage` 函式的 `_messageId` 欄位輸入：`0`
   - 點擊執行
   - **預期結果**：顯示第一則留言的詳細資訊

3. **讀取最新留言**
   - 在 `getLatestMessages` 函式的 `_count` 欄位輸入：`5`
   - 點擊執行
   - **預期結果**：顯示最新的留言（目前只有一則）

### ✅ **測試四：多則留言測試**

**目標**：測試多則留言的情況

1. **發布更多留言**
   - 使用 `postMessage` 發布以下 CID：
     - `QmTestMessage2`
     - `QmTestMessage3`
     - `QmUserStory1`

2. **驗證留言數量**
   - 點擊 `getTotalMessages`
   - **預期結果**：`4`

3. **測試最新留言查詢**
   - 使用 `getLatestMessages` 查詢最新 2 則留言
   - **預期結果**：應該返回最後發布的兩則留言，且順序為最新到最舊

### ✅ **測試五：使用者留言查詢**

**目標**：測試使用者特定留言查詢功能

1. **查詢當前使用者的留言**
   - 在 `getUserMessages` 的 `_user` 欄位輸入當前錢包地址
   - 點擊執行
   - **預期結果**：顯示該使用者發布的所有留言

2. **查詢使用者留言數量**
   - 在 `getUserMessageCount` 的 `_user` 欄位輸入當前錢包地址
   - 點擊執行
   - **預期結果**：顯示該使用者的留言總數

### ✅ **測試六：錯誤處理測試**

**目標**：測試輸入驗證和錯誤處理

1. **測試空 CID**
   - 使用 `postMessage` 發布空字串 `""`
   - **預期結果**：交易失敗，顯示錯誤訊息 "CID cannot be empty"

2. **測試過長 CID**
   - 輸入超過 100 字元的字串
   - **預期結果**：交易失敗，顯示錯誤訊息 "CID too long"

3. **測試不存在的留言 ID**
   - 使用 `getMessage` 查詢 ID `999`
   - **預期結果**：失敗，顯示 "Message does not exist"

### ✅ **測試七：管理功能測試**

**目標**：測試合約的管理功能

1. **暫停合約**
   - 使用 `setPaused` 函式，設定為 `true`
   - **預期結果**：交易成功

2. **驗證暫停狀態**
   - 點擊 `isPaused`
   - **預期結果**：`true`

3. **測試暫停期間發布**
   - 嘗試使用 `postMessage` 發布新留言
   - **預期結果**：交易失敗，顯示 "Contract is paused"

4. **恢復合約**
   - 使用 `setPaused` 函式，設定為 `false`
   - **預期結果**：交易成功，可以繼續發布留言

---

## 常見問題與解決方案

### ❓ **部署相關問題**

#### **問題：合約編譯失敗**
```
Error: Solidity compilation failed
```

**解決方案：**
1. 檢查 Solidity 語法錯誤
2. 確認 pragma 版本正確
3. 檢查 import 路徑

```bash
# 清理並重新編譯
yarn clean
yarn compile
```

#### **問題：部署腳本找不到**
```
Error: No deployment scripts found
```

**解決方案：**
1. 確認 `deploy/` 目錄存在
2. 檢查檔案命名格式：`00_deploy_message_board.ts`
3. 驗證檔案內容和 export

#### **問題：Gas 不足**
```
Error: Transaction ran out of gas
```

**解決方案：**
在 `hardhat.config.ts` 中增加 gas limit：

```typescript
const config: HardhatUserConfig = {
  networks: {
    localhost: {
      gas: 5000000,
      gasPrice: 8000000000,
    },
  },
};
```

### ❓ **前端連接問題**

#### **問題：前端無法連接到合約**
```
Error: Contract not found
```

**解決方案：**
1. 確認 `yarn chain` 正在運行
2. 重新部署合約：`yarn deploy`
3. 重新啟動前端：`yarn start`

#### **問題：MetaMask 網路錯誤**
```
Error: Unsupported chain
```

**解決方案：**
1. 在 MetaMask 中添加本地網路：
   - 網路名稱：Localhost 8545
   - RPC URL：http://127.0.0.1:8545
   - Chain ID：31337
   - 貨幣符號：ETH

2. 切換到本地網路
3. 導入測試帳戶私鑰

### ❓ **Debug Contracts 問題**

#### **問題：看不到合約介面**
**解決方案：**
1. 確認合約部署成功
2. 重新整理頁面
3. 檢查瀏覽器控制台錯誤

#### **問題：函式呼叫失敗**
**解決方案：**
1. 檢查錢包連接狀態
2. 確認帳戶有足夠的 ETH
3. 檢查參數格式是否正確

### ❓ **性能優化**

#### **問題：查詢速度慢**
**解決方案：**
1. 使用 `getLatestMessages` 而非 `getAllMessages`
2. 實現分頁查詢
3. 考慮使用事件過濾

#### **問題：Gas 費用高**
**解決方案：**
1. 優化合約邏輯
2. 使用 events 替代 storage 讀取
3. 批次處理多個操作

---

## 📊 測試結果檢查表

完成所有測試後，確認以下項目：

- [ ] ✅ 合約成功部署
- [ ] ✅ 基本讀寫功能正常
- [ ] ✅ 留言發布和讀取功能
- [ ] ✅ 使用者查詢功能
- [ ] ✅ 錯誤處理機制
- [ ] ✅ 管理功能（暫停/恢復）
- [ ] ✅ 事件正確觸發
- [ ] ✅ Gas 費用合理
- [ ] ✅ 前端介面流暢

---

## 🎯 進階測試建議

### **效能測試**
```bash
# 在 hardhat console 中測試大量留言
const promises = [];
for(let i = 0; i < 100; i++) {
  promises.push(messageBoard.postMessage(`QmTestBatch${i}`));
}
await Promise.all(promises);
```

### **並發測試**
```javascript
// 測試多個使用者同時發布留言
const [user1, user2, user3] = await ethers.getSigners();

await Promise.all([
  messageBoard.connect(user1).postMessage("QmUser1Message"),
  messageBoard.connect(user2).postMessage("QmUser2Message"),
  messageBoard.connect(user3).postMessage("QmUser3Message"),
]);
```

### **邊界值測試**
```javascript
// 測試最大長度 CID
const maxCid = "Q" + "m".repeat(99); // 100 字元
await messageBoard.postMessage(maxCid);

// 測試超過最大長度
const oversizeCid = "Q" + "m".repeat(100); // 101 字元
// 應該失敗
```

---

## 📝 本課總結

### **已掌握的技能**

1. ✅ **部署流程**：從編譯到部署的完整流程
2. ✅ **測試方法**：使用 Debug Contracts 進行全面測試
3. ✅ **錯誤處理**：識別和解決常見問題
4. ✅ **性能評估**：了解合約的 Gas 消耗和性能特徵

### **關鍵學習點**

1. **系統性測試**：按功能模組逐一驗證
2. **邊界測試**：測試極限情況和錯誤處理
3. **使用者體驗**：從使用者角度驗證功能完整性
4. **問題解決**：掌握常見問題的診斷和解決方法

### **下一階段預告**

恭喜！您已經完成了智能合約的開發和測試。在模組四中，我們將進入最激動人心的部分：
1. 建立前端與 IPFS 的整合
2. 實現完整的使用者互動流程
3. 打造一個真正的去中心化應用

---

## 🔗 延伸閱讀

- [Hardhat 部署指南](https://hardhat.org/tutorial/deploying-to-a-live-network.html)
- [Scaffold-eth-2 文件](https://docs.scaffoldeth.io/)
- [智能合約測試最佳實踐](https://ethereum.org/en/developers/docs/smart-contracts/testing/)

**下一模組：** [模組四：前端整合 - 連接 IPFS 與區塊鏈](../模組四/第一課-前端架構與環境變數設定.md)
