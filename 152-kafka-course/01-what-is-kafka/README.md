# 01 - 什麼是 Kafka

## 學習目標

在本章節中，你將學到：

- 什麼是消息隊列（Message Queue）
- Kafka 的誕生背景和設計目標
- Kafka 與傳統消息隊列的區別
- Kafka 的典型應用場景

## 消息隊列簡介

### 什麼是消息隊列？

想像一下，你在一家餐廳工作：

- **沒有消息隊列的情況**：客人直接對著廚師點餐，廚師必須停下手邊的工作來記錄訂單。如果同時來了很多客人，廚師會手忙腳亂。

- **有消息隊列的情況**：客人把訂單寫在紙上，放進一個盒子（隊列）。廚師可以按照自己的節奏從盒子裡取出訂單，一個一個處理。

消息隊列就是這樣一個「盒子」，它在系統的不同部分之間傳遞信息（消息），讓它們可以：

1. **解耦**：發送方和接收方不需要同時在線
2. **緩衝**：處理速度不同時，消息可以暫存在隊列中
3. **非同步處理**：發送方不需要等待接收方處理完成

### 傳統的消息隊列

在 Kafka 出現之前，市場上已經有許多成熟的消息隊列系統：

- **RabbitMQ**：基於 AMQP 協議，功能豐富
- **ActiveMQ**：Java 生態中的經典選擇
- **ZeroMQ**：高性能的輕量級方案

這些系統主要是為「**傳統的消息傳遞**」設計的，適合：
- 請求/響應模式
- 工作隊列
- 發布/訂閱

## Kafka 的誕生

### 背景故事

Kafka 最初是由 LinkedIn 在 2010 年開發的，當時他們面臨的問題是：

**問題**：LinkedIn 每天產生海量的用戶活動數據（點擊、瀏覽、搜索等），需要：
1. 實時收集這些數據
2. 將數據分發給多個下游系統（分析系統、推薦系統、監控系統等）
3. 保證數據不丟失
4. 能夠處理每秒數百萬條消息

**現有方案的局限**：
- 傳統消息隊列無法處理如此大的吞吐量
- 數據倉庫工具無法提供實時處理能力
- 自建系統成本太高

**解決方案**：LinkedIn 團隊開發了 Kafka，一個全新的分布式流處理平台。

### Kafka 的設計目標

Kafka 在設計時有幾個核心目標：

1. **高吞吐量**
   - 每秒處理數百萬條消息
   - 單個服務器就能達到 MB/s 級別的讀寫速度

2. **可擴展性**
   - 輕鬆擴展到數百個節點
   - 無需停機即可擴容

3. **持久化**
   - 消息持久化到磁碟
   - 支持數據重放（重新消費歷史數據）

4. **容錯性**
   - 數據副本機制
   - 節點故障時自動恢復

5. **實時性**
   - 低延遲（毫秒級）
   - 支持實時流處理

### Kafka 的名字由來

有趣的是，Kafka 的名字來自捷克作家 Franz Kafka（弗朗茨·卡夫卡）。開發者 Jay Kreps 選擇這個名字是因為：
- 他喜歡 Kafka 的作品
- 這是一個用於寫入（writing）的系統
- 這個名字簡短好記

## Kafka vs 傳統消息隊列

讓我們看看 Kafka 與傳統消息隊列（以 RabbitMQ 為例）的主要區別：

### 對比表

| 特性 | Kafka | RabbitMQ |
|------|-------|----------|
| **設計目標** | 高吞吐量的流處理平台 | 可靠的消息傳遞 |
| **消息模型** | 發布/訂閱（基於主題） | 多種模式（點對點、發布/訂閱等） |
| **性能** | 極高（每秒百萬級消息） | 高（每秒數萬條消息） |
| **持久化** | 所有消息都持久化 | 可選持久化 |
| **消息順序** | 保證分區內有序 | 可以保證隊列內有序 |
| **消息保留** | 基於時間或大小，默認保留 | 消費後即刪除 |
| **消息重放** | 支持（可重複消費） | 不支持（消費後刪除） |
| **路由能力** | 基本（通過分區） | 豐富（複雜的路由規則） |
| **適用場景** | 大數據、日誌收集、流處理 | 應用解耦、任務隊列 |

### 核心差異

**1. 消息保留策略**

```
RabbitMQ:  [消息] → [隊列] → [消費者消費] → [消息被刪除]

Kafka:     [消息] → [主題] → [消費者消費] → [消息仍然保留，可重複消費]
```

**2. 數據模型**

- **RabbitMQ**：消息是隊列的核心，消費者從隊列中取出消息
- **Kafka**：日誌（log）是核心，消息被追加到日誌末尾，消費者讀取日誌

**3. 性能哲學**

- **RabbitMQ**：注重消息的靈活路由和可靠投遞
- **Kafka**：注重極致的吞吐量和可擴展性

## Kafka 的典型應用場景

### 1. 日誌收集

**場景**：一個公司有 100 個微服務，每個服務每天產生數 GB 的日誌。

**傳統方案**：每個服務將日誌寫入文件，定期上傳到中央日誌服務器。
- ❌ 實時性差
- ❌ 文件管理複雜
- ❌ 擴展困難

**Kafka 方案**：每個服務將日誌發送到 Kafka。
- ✅ 實時收集
- ✅ 統一入口
- ✅ 可以多個系統同時消費（ELK、監控系統、分析系統）

```
微服務A ──┐
微服務B ──┼──→ Kafka (日誌主題) ──┬──→ ELK Stack (搜索和查詢)
微服務C ──┘                        ├──→ 監控系統 (告警)
...                                └──→ 數據倉庫 (長期存儲)
```

### 2. 實時數據管道

**場景**：電商網站需要實時同步數據到多個系統。

```
用戶操作 → 應用服務器 → Kafka → ┬ → 推薦系統（實時更新推薦）
                                  ├ → 數據分析系統（用戶行為分析）
                                  ├ → 搜索引擎（更新搜索索引）
                                  └ → 數據倉庫（歷史數據存儲）
```

**優勢**：
- 單一數據來源
- 各系統獨立消費，互不影響
- 新系統可以隨時接入

### 3. 事件驅動架構

**場景**：訂單系統在用戶下單後，需要觸發多個後續操作。

```
用戶下單 → 訂單服務 → Kafka (訂單事件) → ┬ → 庫存服務（扣減庫存）
                                          ├ → 支付服務（等待支付）
                                          ├ → 物流服務（準備配送）
                                          └ → 通知服務（發送確認郵件）
```

**優勢**：
- 訂單服務不需要知道有哪些下游服務
- 新增服務不影響現有系統
- 服務之間低耦合

### 4. 微服務間通訊

**場景**：在微服務架構中，服務之間需要通訊。

**同步通訊（REST API）的問題**：
- 服務依賴性強
- 一個服務故障影響整條鏈路
- 性能瓶頸

**使用 Kafka 進行非同步通訊**：
- 服務解耦
- 緩衝流量高峰
- 容錯能力強

### 5. 數據同步

**場景**：將數據庫的變更實時同步到其他系統。

```
MySQL → Kafka Connect → Kafka → ┬ → Elasticsearch（全文搜索）
                                 ├ → Redis（緩存）
                                 └ → 數據倉庫（分析）
```

這種模式稱為 **CDC（Change Data Capture）**，Kafka 生態中的工具（如 Debezium）可以自動捕獲數據庫變更。

## Kafka 不適合的場景

公平地說，Kafka 也不是萬能的。以下場景可能不太適合：

1. **需要複雜消息路由**：RabbitMQ 更合適
2. **小規模應用**（每秒幾百條消息）：可能太重量級
3. **需要強事務性的請求/響應**：傳統 RPC 或 REST API 更合適
4. **需要消息優先級**：Kafka 不支持消息優先級

## 小結

在本章中，我們學習了：

1. **消息隊列的基本概念**：在系統間傳遞消息的中間件
2. **Kafka 的誕生背景**：LinkedIn 為處理海量實時數據而開發
3. **Kafka vs 傳統消息隊列**：
   - Kafka 注重高吞吐量和可擴展性
   - Kafka 消息持久化，支持重放
   - Kafka 更適合流數據處理
4. **Kafka 的典型應用場景**：
   - 日誌收集
   - 實時數據管道
   - 事件驅動架構
   - 微服務通訊
   - 數據同步

## 思考題

1. 你的工作或項目中，有哪些場景可以使用 Kafka？
2. 對於一個簡單的任務隊列（如發送郵件），你會選擇 Kafka 還是 RabbitMQ？為什麼？
3. Kafka 的消息保留特性（消費後不刪除）帶來了什麼好處？

## 下一步

現在你已經了解了 Kafka 是什麼以及它的應用場景。在下一章中，我們將深入學習 Kafka 的核心概念和術語。

👉 [下一章：02 - 核心概念與術語](../02-core-concepts/README.md)

---

[返回目錄](../README.md)

