# 02 - æ ¸å¿ƒæ¦‚å¿µèˆ‡è¡“èª

## å­¸ç¿’ç›®æ¨™

åœ¨æœ¬ç« ç¯€ä¸­ï¼Œä½ å°‡å­¸åˆ°ï¼š

- Kafka çš„æ ¸å¿ƒçµ„ä»¶å’Œè¡“èª
- Kafka çš„æ•´é«”æ¶æ§‹
- å„çµ„ä»¶ä¹‹é–“å¦‚ä½•å”åŒå·¥ä½œ

## Kafka æ¶æ§‹å…¨æ™¯åœ–

åœ¨æ·±å…¥å„å€‹æ¦‚å¿µä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆçœ‹çœ‹ Kafka çš„æ•´é«”æ¶æ§‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kafka Cluster                        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Broker 1   â”‚  â”‚  Broker 2   â”‚  â”‚  Broker 3   â”‚         â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚         â”‚
â”‚  â”‚ Topic: ordersâ”‚ â”‚ Topic: ordersâ”‚ â”‚ Topic: ordersâ”‚         â”‚
â”‚  â”‚ Partition 0 â”‚  â”‚ Partition 1 â”‚  â”‚ Partition 2 â”‚         â”‚
â”‚  â”‚ (Leader)    â”‚  â”‚ (Leader)    â”‚  â”‚ (Follower)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                                      â”‚
         â”‚                                      â”‚
    [Producer]                             [Consumer]
   (ç”Ÿç”¢è€…)                               (æ¶ˆè²»è€…)
   ç™¼é€æ¶ˆæ¯                               è®€å–æ¶ˆæ¯
```

ç¾åœ¨è®“æˆ‘å€‘é€ä¸€äº†è§£æ¯å€‹çµ„ä»¶ã€‚

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Messageï¼ˆæ¶ˆæ¯ï¼‰

**å®šç¾©**ï¼šKafka ä¸­æ•¸æ“šå‚³è¼¸çš„åŸºæœ¬å–®ä½ã€‚

**çµ„æˆéƒ¨åˆ†**ï¼š
- **Key**ï¼ˆéµï¼‰ï¼šå¯é¸ï¼Œç”¨æ–¼æ±ºå®šæ¶ˆæ¯ç™¼é€åˆ°å“ªå€‹åˆ†å€
- **Value**ï¼ˆå€¼ï¼‰ï¼šæ¶ˆæ¯çš„å¯¦éš›å…§å®¹
- **Timestamp**ï¼ˆæ™‚é–“æˆ³ï¼‰ï¼šæ¶ˆæ¯çš„æ™‚é–“æ¨™è¨˜
- **Headers**ï¼ˆæ¨™é ­ï¼‰ï¼šå¯é¸çš„å…ƒæ•¸æ“š

**é¡æ¯”**ï¼šæ¶ˆæ¯å°±åƒä¸€å°ä¿¡
- Key æ˜¯æ”¶ä»¶äººåœ°å€ï¼ˆæ±ºå®šé€åˆ°å“ªå€‹ä¿¡ç®±ï¼‰
- Value æ˜¯ä¿¡ä»¶å…§å®¹
- Timestamp æ˜¯éƒµæˆ³
- Headers æ˜¯é¡å¤–çš„æ¨™ç±¤ï¼ˆå¦‚ã€Œç·Šæ€¥ã€ã€ã€Œæ©Ÿå¯†ã€ï¼‰

**ç¤ºä¾‹**ï¼š
```json
{
  "key": "user-12345",
  "value": {
    "userId": "12345",
    "action": "purchase",
    "amount": 99.99,
    "timestamp": "2024-01-01T10:30:00Z"
  },
  "headers": {
    "source": "web-app",
    "version": "1.0"
  }
}
```

### 2. Topicï¼ˆä¸»é¡Œï¼‰

**å®šç¾©**ï¼šæ¶ˆæ¯çš„åˆ†é¡æˆ–é »é“ï¼ŒProducer ç™¼é€æ¶ˆæ¯åˆ° Topicï¼ŒConsumer å¾ Topic è®€å–æ¶ˆæ¯ã€‚

**ç‰¹é»**ï¼š
- Topic æ˜¯é‚è¼¯æ¦‚å¿µï¼Œé¡ä¼¼è³‡æ–™åº«ä¸­çš„ã€Œè¡¨ã€
- ä¸€å€‹ Kafka é›†ç¾¤å¯ä»¥æœ‰å¤šå€‹ Topic
- Topic åç¨±åœ¨é›†ç¾¤ä¸­å”¯ä¸€

**é¡æ¯”**ï¼š
- å ±ç´™æœ‰ä¸åŒç‰ˆé¢ï¼šé«”è‚²ç‰ˆã€è²¡ç¶“ç‰ˆã€å¨›æ¨‚ç‰ˆ
- Topic å°±åƒé€™äº›ç‰ˆé¢ï¼Œä¸åŒé¡å‹çš„æ–°èï¼ˆæ¶ˆæ¯ï¼‰ç™¼å¸ƒåˆ°ä¸åŒç‰ˆé¢

**å‘½åå»ºè­°**ï¼š
```
å¥½çš„å‘½åï¼š
- user-events
- order-created
- payment-completed

ä¸å¥½çš„å‘½åï¼š
- data
- test123
- topic1
```

**ç¤ºä¾‹å ´æ™¯**ï¼š
```
é›»å•†ç³»çµ±çš„ Topicsï¼š
- ordersï¼ˆè¨‚å–®ï¼‰
- paymentsï¼ˆæ”¯ä»˜ï¼‰
- inventoryï¼ˆåº«å­˜ï¼‰
- user-activitiesï¼ˆç”¨æˆ¶æ´»å‹•ï¼‰
- notificationsï¼ˆé€šçŸ¥ï¼‰
```

### 3. Partitionï¼ˆåˆ†å€ï¼‰

**å®šç¾©**ï¼šTopic è¢«åˆ†æˆå¤šå€‹ Partitionï¼Œæ¯å€‹ Partition æ˜¯ä¸€å€‹æœ‰åºçš„æ¶ˆæ¯åºåˆ—ã€‚

**ç‚ºä»€éº¼éœ€è¦åˆ†å€ï¼Ÿ**

1. **ä¸¦è¡Œè™•ç†**ï¼šå¤šå€‹ Consumer å¯ä»¥åŒæ™‚è®€å–ä¸åŒçš„åˆ†å€
2. **å¯æ“´å±•æ€§**ï¼šåˆ†å€å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„ Broker ä¸Š
3. **æ€§èƒ½æå‡**ï¼šè®€å¯«å¯ä»¥åˆ†æ•£åˆ°å¤šå€‹ç£ç¢Ÿ

**é‡è¦ç‰¹æ€§**ï¼š

âœ… **åˆ†å€å…§æœ‰åº**ï¼šåŒä¸€åˆ†å€å…§çš„æ¶ˆæ¯æŒ‰å¯«å…¥é †åºæ’åˆ—
âŒ **è·¨åˆ†å€ç„¡åº**ï¼šä¸åŒåˆ†å€ä¹‹é–“æ²’æœ‰é †åºä¿è­‰

**é¡æ¯”**ï¼š
æƒ³åƒä¸€å€‹å¤§å‹åœ–æ›¸é¤¨ï¼š
- Topic æ˜¯ä¸€å€‹ä¸»é¡Œå€åŸŸï¼ˆå¦‚ã€Œè¨ˆç®—æ©Ÿé¡ã€ï¼‰
- Partition æ˜¯è©²å€åŸŸçš„ä¸åŒæ›¸æ¶
- æ¯å€‹æ›¸æ¶ä¸Šçš„æ›¸æŒ‰ç·¨è™Ÿæ’åˆ—ï¼ˆæœ‰åºï¼‰
- ä½†ä¸åŒæ›¸æ¶ä¹‹é–“æ²’æœ‰å…¨å±€é †åº

**è¦–è¦ºåŒ–**ï¼š

```
Topic: user-events (3 å€‹åˆ†å€)

Partition 0: [msg0] â†’ [msg3] â†’ [msg6] â†’ [msg9]  ...
Partition 1: [msg1] â†’ [msg4] â†’ [msg7] â†’ [msg10] ...
Partition 2: [msg2] â†’ [msg5] â†’ [msg8] â†’ [msg11] ...
             â†‘                    â†‘
           èˆŠæ¶ˆæ¯              æ–°æ¶ˆæ¯
          (offset 0)         (offset 3)
```

**åˆ†å€æ•¸é‡å¦‚ä½•æ±ºå®šï¼Ÿ**

- å¤ªå°‘ï¼šç„¡æ³•å……åˆ†åˆ©ç”¨ä¸¦è¡Œæ€§
- å¤ªå¤šï¼šå¢åŠ ç®¡ç†é–‹éŠ·
- ç¶“é©—æ³•å‰‡ï¼šè€ƒæ…® Consumer æ•¸é‡å’ŒæœŸæœ›çš„ååé‡
- å¯ä»¥åœ¨å‰µå»ºå¾Œå¢åŠ ï¼ˆä½†ä¸å»ºè­°æ¸›å°‘ï¼‰

### 4. Offsetï¼ˆåç§»é‡ï¼‰

**å®šç¾©**ï¼šPartition ä¸­æ¯æ¢æ¶ˆæ¯çš„å”¯ä¸€åºè™Ÿï¼Œå¾ 0 é–‹å§‹éå¢ã€‚

**ä½œç”¨**ï¼š
- æ¨™è­˜æ¶ˆæ¯åœ¨åˆ†å€ä¸­çš„ä½ç½®
- Consumer é€šé Offset è¿½è¹¤å·²è®€å–çš„æ¶ˆæ¯

**é¡æ¯”**ï¼š
- æ›¸ç±çš„é ç¢¼
- è¦–é »æ’­æ”¾çš„é€²åº¦æ¢
- ä½ å¯ä»¥è¨˜ä½çœ‹åˆ°ç¬¬å¹¾é ï¼Œä¸‹æ¬¡å¾é‚£è£¡ç¹¼çºŒçœ‹

**ç¤ºä¾‹**ï¼š

```
Partition 0:
Offset: 0    1    2    3    4    5    6
æ¶ˆæ¯:  [A] [B] [C] [D] [E] [F] [G]
                    â†‘
              Consumer ç•¶å‰ä½ç½®
         (å·²è®€å–åˆ° offset 3)
```

**é‡è¦æ¦‚å¿µ**ï¼š

- **Current Offset**ï¼šConsumer ç•¶å‰è®€å–çš„ä½ç½®
- **Committed Offset**ï¼šConsumer å·²ç¢ºèªè™•ç†å®Œæˆçš„ä½ç½®
- **Log-End Offset**ï¼šåˆ†å€ä¸­æœ€æ–°æ¶ˆæ¯çš„ offset

### 5. Producerï¼ˆç”Ÿç”¢è€…ï¼‰

**å®šç¾©**ï¼šå‘ Kafka Topic ç™¼é€æ¶ˆæ¯çš„å®¢æˆ¶ç«¯æ‡‰ç”¨ç¨‹åºã€‚

**ä¸»è¦è·è²¬**ï¼š
1. é€£æ¥åˆ° Kafka é›†ç¾¤
2. åºåˆ—åŒ–æ¶ˆæ¯ï¼ˆå°‡å°è±¡è½‰æ›ç‚ºå­—ç¯€ï¼‰
3. æ±ºå®šæ¶ˆæ¯ç™¼é€åˆ°å“ªå€‹åˆ†å€
4. ç™¼é€æ¶ˆæ¯ä¸¦è™•ç†éŸ¿æ‡‰

**åˆ†å€é¸æ“‡é‚è¼¯**ï¼š

```
å¦‚æœæ¶ˆæ¯æœ‰ Keyï¼š
    ä½¿ç”¨ hash(key) % åˆ†å€æ•¸ â†’ æ±ºå®šåˆ†å€
    ç›¸åŒ key çš„æ¶ˆæ¯æœƒè¢«ç™¼é€åˆ°åŒä¸€åˆ†å€ï¼ˆä¿è­‰é †åºï¼‰

å¦‚æœæ¶ˆæ¯æ²’æœ‰ Keyï¼š
    ä½¿ç”¨è¼ªè©¢ï¼ˆround-robinï¼‰æˆ–å…¶ä»–ç­–ç•¥åˆ†é…
```

**é¡æ¯”**ï¼š
- Producer å°±åƒéƒµå±€å¯„ä»¶å“¡
- çŸ¥é“è¦å¯„åˆ°å“ªå€‹åœ°å€ï¼ˆTopicï¼‰
- æ±ºå®šä½¿ç”¨å“ªå€‹éƒµç®±ï¼ˆPartitionï¼‰
- ç¢ºèªä¿¡ä»¶æ˜¯å¦æˆåŠŸæŠ•é

**åŸºæœ¬æµç¨‹**ï¼š

```
1. å‰µå»º Producer å¯¦ä¾‹
2. æº–å‚™æ¶ˆæ¯ï¼ˆkey, value, headersï¼‰
3. ç™¼é€æ¶ˆæ¯åˆ°æŒ‡å®š Topic
4. ç­‰å¾…ç¢ºèªï¼ˆå¯é¸ï¼‰
5. é—œé–‰ Producer
```

### 6. Consumerï¼ˆæ¶ˆè²»è€…ï¼‰

**å®šç¾©**ï¼šå¾ Kafka Topic è®€å–æ¶ˆæ¯çš„å®¢æˆ¶ç«¯æ‡‰ç”¨ç¨‹åºã€‚

**ä¸»è¦è·è²¬**ï¼š
1. é€£æ¥åˆ° Kafka é›†ç¾¤
2. è¨‚é–±ä¸€å€‹æˆ–å¤šå€‹ Topic
3. å¾åˆ†é…çš„ Partition è®€å–æ¶ˆæ¯
4. ååºåˆ—åŒ–æ¶ˆæ¯ï¼ˆå°‡å­—ç¯€è½‰æ›ç‚ºå°è±¡ï¼‰
5. è™•ç†æ¶ˆæ¯
6. æäº¤ Offsetï¼ˆè¨˜éŒ„è™•ç†é€²åº¦ï¼‰

**é¡æ¯”**ï¼š
- Consumer å°±åƒè¨‚é–±å ±ç´™çš„è®€è€…
- æ¯å¤©å¾ä¿¡ç®±å–å‡ºå ±ç´™ï¼ˆPartitionï¼‰
- é–±è®€å…§å®¹ï¼ˆè™•ç†æ¶ˆæ¯ï¼‰
- è¨˜ä½çœ‹åˆ°å“ªä¸€é ï¼ˆæäº¤ Offsetï¼‰

**æ¶ˆè²»æ–¹å¼**ï¼š

```
æ‹‰å–æ¨¡å¼ï¼ˆPullï¼‰ï¼š
Consumer ä¸»å‹•å‘ Broker è«‹æ±‚æ•¸æ“š
â†“
å¥½è™•ï¼šConsumer å¯ä»¥æŒ‰è‡ªå·±çš„é€Ÿåº¦æ¶ˆè²»
```

### 7. Consumer Groupï¼ˆæ¶ˆè²»è€…ç¾¤çµ„ï¼‰

**å®šç¾©**ï¼šä¸€çµ„å…±åŒæ¶ˆè²»åŒä¸€å€‹ Topic çš„ Consumerã€‚

**æ ¸å¿ƒè¦å‰‡**ï¼š
- ç¾¤çµ„å…§æ¯å€‹ Partition åªèƒ½è¢«ä¸€å€‹ Consumer æ¶ˆè²»
- ä¸€å€‹ Consumer å¯ä»¥æ¶ˆè²»å¤šå€‹ Partition
- ä¸åŒç¾¤çµ„ä¹‹é–“äº’ä¸å½±éŸ¿ï¼Œå„è‡ªç¨ç«‹æ¶ˆè²»

**è¦–è¦ºåŒ–**ï¼š

```
Topic: orders (4 å€‹åˆ†å€)

Consumer Group A (2 å€‹ consumers):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Consumer 1 â”‚ â† Partition 0   â”‚ Consumer 2 â”‚
â”‚            â”‚ â† Partition 1   â”‚            â”‚
â”‚            â”‚                 â”‚            â”‚ â† Partition 2
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â† Partition 3

Consumer Group B (3 å€‹ consumers):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Consumer 1 â”‚  â”‚ Consumer 2 â”‚  â”‚ Consumer 3 â”‚
â”‚            â”‚  â”‚            â”‚  â”‚            â”‚
â”‚            â”‚  â”‚            â”‚  â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘               â†‘               â†‘
 Partition 0    Partition 1    Partition 2
                               Partition 3
```

**ä½¿ç”¨å ´æ™¯**ï¼š

**å ´æ™¯ 1ï¼šè² è¼‰å‡è¡¡**
```
4 å€‹åˆ†å€ + 4 å€‹ Consumerï¼ˆåŒä¸€ç¾¤çµ„ï¼‰
= æ¯å€‹ Consumer è™•ç† 1 å€‹åˆ†å€
= ä¸¦è¡Œè™•ç†ï¼Œæé«˜ååé‡
```

**å ´æ™¯ 2ï¼šå¤šå€‹ç¨ç«‹æ‡‰ç”¨**
```
Topic: user-events

Consumer Group: analytics-service
â†’ ç”¨æ–¼æ•¸æ“šåˆ†æ

Consumer Group: notification-service
â†’ ç”¨æ–¼ç™¼é€é€šçŸ¥

å…©å€‹æœå‹™ç¨ç«‹æ¶ˆè²»ç›¸åŒçš„æ•¸æ“š
```

**é‡è¦æç¤º**ï¼š
- Consumer æ•¸é‡ > Partition æ•¸é‡ï¼šæœƒæœ‰ç©ºé–’çš„ Consumer
- Consumer æ•¸é‡ < Partition æ•¸é‡ï¼šä¸€å€‹ Consumer è™•ç†å¤šå€‹ Partition
- æœ€ä½³å¯¦è¸ï¼šConsumer æ•¸é‡ = Partition æ•¸é‡

### 8. Brokerï¼ˆä»£ç†ï¼‰

**å®šç¾©**ï¼šKafka æœå‹™å™¨ï¼Œè² è²¬æ¥æ”¶ã€å­˜å„²å’Œç™¼é€æ¶ˆæ¯ã€‚

**ä¸»è¦è·è²¬**ï¼š
1. æ¥æ”¶ä¾†è‡ª Producer çš„æ¶ˆæ¯
2. å°‡æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç¢Ÿ
3. éŸ¿æ‡‰ Consumer çš„è®€å–è«‹æ±‚
4. ç®¡ç† Partition çš„å‰¯æœ¬
5. åƒèˆ‡é›†ç¾¤çš„å”èª¿å·¥ä½œ

**ç‰¹é»**ï¼š
- ä¸€å€‹ Kafka é›†ç¾¤é€šå¸¸æœ‰å¤šå€‹ Broker
- æ¯å€‹ Broker æœ‰ä¸€å€‹å”¯ä¸€çš„ ID
- Broker ä¹‹é–“é€šéç¶²çµ¡é€šè¨Š
- å¯ä»¥å‹•æ…‹å¢åŠ æˆ–ç§»é™¤ Broker

**é¡æ¯”**ï¼š
- Broker å°±åƒéŠ€è¡Œçš„åˆ†è¡Œ
- æ¯å€‹åˆ†è¡Œï¼ˆBrokerï¼‰å­˜å„²éƒ¨åˆ†æ•¸æ“šï¼ˆPartitionï¼‰
- å®¢æˆ¶ï¼ˆProducer/Consumerï¼‰å¯ä»¥èˆ‡ä»»ä½•åˆ†è¡Œäº’å‹•
- åˆ†è¡Œä¹‹é–“äº’ç›¸å‚™ä»½ï¼ˆå‰¯æœ¬æ©Ÿåˆ¶ï¼‰

**è¦–è¦ºåŒ–**ï¼š

```
Kafka Cluster (3 å€‹ Brokers)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Broker 0       â”‚  â”‚   Broker 1       â”‚  â”‚   Broker 2       â”‚
â”‚   (ID: 0)        â”‚  â”‚   (ID: 1)        â”‚  â”‚   (ID: 2)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Topic-A-Part-0   â”‚  â”‚ Topic-A-Part-1   â”‚  â”‚ Topic-A-Part-2   â”‚
â”‚ Topic-B-Part-0   â”‚  â”‚ Topic-B-Part-2   â”‚  â”‚ Topic-B-Part-1   â”‚
â”‚ Topic-C-Part-1   â”‚  â”‚ Topic-C-Part-0   â”‚  â”‚ Topic-C-Part-2   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9. Clusterï¼ˆé›†ç¾¤ï¼‰

**å®šç¾©**ï¼šå¤šå€‹ Broker çµ„æˆçš„ Kafka é›†ç¾¤ã€‚

**å„ªå‹¢**ï¼š
- **é«˜å¯ç”¨æ€§**ï¼šå–®å€‹ Broker æ•…éšœä¸å½±éŸ¿æ•´é«”æœå‹™
- **å¯æ“´å±•æ€§**ï¼šå¯ä»¥å¢åŠ  Broker ä¾†æå‡æ€§èƒ½
- **è² è¼‰å‡è¡¡**ï¼šæ•¸æ“šå’Œè«‹æ±‚åˆ†æ•£åˆ°å¤šå€‹ Broker

**å”èª¿æ©Ÿåˆ¶**ï¼š
- ä½¿ç”¨ ZooKeeperï¼ˆå‚³çµ±æ–¹å¼ï¼‰æˆ– KRaftï¼ˆæ–°æ–¹å¼ï¼‰
- é¸èˆ‰ Controller Broker
- ç®¡ç†é›†ç¾¤å…ƒæ•¸æ“š

## æ¦‚å¿µä¹‹é–“çš„é—œä¿‚

è®“æˆ‘å€‘çœ‹çœ‹é€™äº›æ¦‚å¿µå¦‚ä½•å”åŒå·¥ä½œï¼š

### å®Œæ•´çš„æ¶ˆæ¯æµç¨‹

```
1. Producer ç™¼é€æ¶ˆæ¯
   â†“
2. æ¶ˆæ¯è¢«è·¯ç”±åˆ°ç‰¹å®šçš„ Topic å’Œ Partition
   â†“
3. Broker æ¥æ”¶ä¸¦æŒä¹…åŒ–æ¶ˆæ¯
   â†“
4. æ¶ˆæ¯è¢«åˆ†é…ä¸€å€‹ Offset
   â†“
5. Consumer Group ä¸­çš„ Consumer å¾ Partition è®€å–
   â†“
6. Consumer è™•ç†æ¶ˆæ¯ä¸¦æäº¤ Offset
```

### å±¤ç´šé—œä¿‚

```
Clusterï¼ˆé›†ç¾¤ï¼‰
  â””â”€â”€ Brokerï¼ˆæœå‹™å™¨ï¼‰
       â””â”€â”€ Topicï¼ˆä¸»é¡Œï¼‰
            â””â”€â”€ Partitionï¼ˆåˆ†å€ï¼‰
                 â””â”€â”€ Messageï¼ˆæ¶ˆæ¯ï¼Œå¸¶ Offsetï¼‰
```

### å¯¦éš›ç¤ºä¾‹

å‡è¨­æˆ‘å€‘è¦æ§‹å»ºä¸€å€‹è¨‚å–®è™•ç†ç³»çµ±ï¼š

```
å ´æ™¯ï¼šè™•ç†ç”¨æˆ¶è¨‚å–®

1. é…ç½®ï¼š
   - Cluster: 3 å€‹ Broker
   - Topic: "orders"
   - Partitions: 6 å€‹åˆ†å€
   - Replication: æ¯å€‹åˆ†å€æœ‰ 3 å€‹å‰¯æœ¬

2. ç”Ÿç”¢è€…ç«¯ï¼š
   - è¨‚å–®æœå‹™ï¼ˆProducerï¼‰ç™¼é€è¨‚å–®åˆ° "orders" Topic
   - ä½¿ç”¨ userId ä½œç‚º Keyï¼ˆç¢ºä¿åŒä¸€ç”¨æˆ¶çš„è¨‚å–®æœ‰åºï¼‰
   
3. æ¶ˆè²»è€…ç«¯ï¼š
   - Consumer Group "inventory-service": 3 å€‹ Consumerï¼Œè™•ç†åº«å­˜æ‰£æ¸›
   - Consumer Group "notification-service": 2 å€‹ Consumerï¼Œç™¼é€é€šçŸ¥
   - Consumer Group "analytics-service": 1 å€‹ Consumerï¼Œæ•¸æ“šåˆ†æ

4. æ•¸æ“šæµï¼š
   è¨‚å–®æœå‹™ â†’ Partition 0-5 â†’ å„ Consumer Group ç¨ç«‹æ¶ˆè²»
```

## é—œéµæ•¸å­—å’Œé™åˆ¶

äº†è§£ä¸€äº›å¯¦éš›çš„æ•¸å­—ï¼Œæœ‰åŠ©æ–¼ç†è§£ Kafka çš„èƒ½åŠ›ï¼š

- **å–®å€‹ Broker**ï¼šå¯è™•ç†æ•¸ç™¾ MB/s çš„ååé‡
- **Partition æ•¸é‡**ï¼šå–®å€‹ Broker å¯ç®¡ç†æ•¸åƒå€‹ Partition
- **æ¶ˆæ¯å¤§å°**ï¼šé»˜èªæœ€å¤§ 1MBï¼ˆå¯é…ç½®ï¼‰
- **ä¿ç•™æ™‚é–“**ï¼šé»˜èª 7 å¤©ï¼ˆå¯é…ç½®ç‚ºç„¡é™æœŸï¼‰
- **Consumer æ•¸é‡**ï¼šå»ºè­°ä¸è¶…é Partition æ•¸é‡ï¼ˆåŒä¸€ Group å…§ï¼‰

## å°çµ

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘å€‘å­¸ç¿’äº† Kafka çš„æ ¸å¿ƒæ¦‚å¿µï¼š

| æ¦‚å¿µ | ç°¡å–®æè¿° | é¡æ¯” |
|-----|----------|------|
| **Message** | æ•¸æ“šçš„åŸºæœ¬å–®ä½ | ä¸€å°ä¿¡ |
| **Topic** | æ¶ˆæ¯çš„åˆ†é¡ | å ±ç´™çš„ç‰ˆé¢ |
| **Partition** | Topic çš„åˆ†ç‰‡ | æ›¸æ¶ |
| **Offset** | æ¶ˆæ¯çš„ä½ç½®æ¨™è­˜ | é ç¢¼ |
| **Producer** | ç™¼é€æ¶ˆæ¯çš„æ‡‰ç”¨ | å¯„ä»¶äºº |
| **Consumer** | æ¥æ”¶æ¶ˆæ¯çš„æ‡‰ç”¨ | æ”¶ä»¶äºº |
| **Consumer Group** | å…±åŒæ¶ˆè²»çš„æ¶ˆè²»è€…çµ„ | è¨‚é–±åŒä¸€å ±ç´™çš„å®¶åº­æˆå“¡ |
| **Broker** | Kafka æœå‹™å™¨ | éƒµå±€ |
| **Cluster** | Broker çš„é›†åˆ | éƒµå±€ç¶²çµ¡ |

**æ ¸å¿ƒè¦é»**ï¼š
1. Partition æ˜¯ä¸¦è¡Œè™•ç†çš„åŸºç¤
2. Consumer Group å¯¦ç¾è² è¼‰å‡è¡¡å’Œå¤šè¨‚é–±è€…æ¨¡å¼
3. Offset ç®¡ç†æ˜¯ Kafka æ¶ˆè²»çš„æ ¸å¿ƒæ©Ÿåˆ¶
4. Broker å’Œ Cluster æä¾›é«˜å¯ç”¨æ€§å’Œå¯æ“´å±•æ€§

## æ€è€ƒé¡Œ

1. å¦‚æœä¸€å€‹ Topic æœ‰ 4 å€‹ Partitionï¼Œä¸€å€‹ Consumer Group æœ‰ 6 å€‹ Consumerï¼Œæœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ
2. ç‚ºä»€éº¼åŒä¸€å€‹ Key çš„æ¶ˆæ¯æœƒè¢«ç™¼é€åˆ°åŒä¸€å€‹ Partitionï¼Ÿé€™æœ‰ä»€éº¼å¥½è™•ï¼Ÿ
3. å…©å€‹ä¸åŒçš„ Consumer Group æ¶ˆè²»åŒä¸€å€‹ Topicï¼Œå®ƒå€‘æœƒäº’ç›¸å½±éŸ¿å—ï¼Ÿ

## ä¸‹ä¸€æ­¥

ç¾åœ¨ä½ å·²ç¶“æŒæ¡äº† Kafka çš„æ ¸å¿ƒæ¦‚å¿µå’Œè¡“èªã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥æ¢è¨ Kafka çš„è¨­è¨ˆå“²å­¸ï¼Œäº†è§£ç‚ºä»€éº¼ Kafka èƒ½å¤ å¦‚æ­¤é«˜æ•ˆã€‚

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼š03 - Kafka çš„è¨­è¨ˆå“²å­¸](../03-design-philosophy/README.md)

---

[è¿”å›ç›®éŒ„](../README.md)

