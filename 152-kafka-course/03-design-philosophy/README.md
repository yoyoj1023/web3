# 03 - Kafka çš„è¨­è¨ˆå“²å­¸

## å­¸ç¿’ç›®æ¨™

åœ¨æœ¬ç« ç¯€ä¸­ï¼Œä½ å°‡å­¸åˆ°ï¼š

- ç‚ºä»€éº¼ Kafka èƒ½é”åˆ°æ¥µé«˜çš„æ€§èƒ½
- Kafka çš„é—œéµè¨­è¨ˆæ±ºç­–
- åˆ†å€èˆ‡ä¸¦è¡Œè™•ç†çš„æ©Ÿåˆ¶
- æŒä¹…åŒ–èˆ‡å¯é æ€§çš„å¹³è¡¡
- Kafka çš„å¯æ“´å±•æ€§è¨­è¨ˆ

## ç‚ºä»€éº¼ Kafka é€™éº¼å¿«ï¼Ÿ

Kafka èƒ½å¤ é”åˆ°æ¯ç§’è™•ç†æ•¸ç™¾è¬æ¢æ¶ˆæ¯çš„æ€§èƒ½ï¼Œé€™ä¸¦ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—ç²¾å¿ƒè¨­è¨ˆçš„çµæœã€‚è®“æˆ‘å€‘é€ä¸€äº†è§£é€™äº›é—œéµæŠ€è¡“ã€‚

### 1. é †åºå¯«å…¥ç£ç¢Ÿ

**æ ¸å¿ƒæ€æƒ³**ï¼šèˆ‡å…¶ä½¿ç”¨è¨˜æ†¶é«”éš¨æ©Ÿå­˜å–ï¼Œä¸å¦‚å–„ç”¨ç£ç¢Ÿçš„é †åºå¯«å…¥ç‰¹æ€§ã€‚

**å‚³çµ±èªçŸ¥** âŒ
```
ç£ç¢Ÿå¾ˆæ…¢ â†’ æ‡‰è©²é¿å…ä½¿ç”¨ç£ç¢Ÿ â†’ æŠŠæ‰€æœ‰æ•¸æ“šæ”¾åœ¨è¨˜æ†¶é«”
```

**Kafka çš„åšæ³•** âœ…
```
é †åºå¯«å…¥ç£ç¢Ÿçš„é€Ÿåº¦æ¥è¿‘è¨˜æ†¶é«”éš¨æ©Ÿå­˜å–
â†’ ä½¿ç”¨ç£ç¢Ÿä½œç‚ºä¸»è¦å­˜å„²
â†’ åˆ©ç”¨ä½œæ¥­ç³»çµ±çš„é ç·©å­˜ï¼ˆPage Cacheï¼‰
```

**æ€§èƒ½å°æ¯”**ï¼š

| æ“ä½œé¡å‹ | é€Ÿåº¦ï¼ˆç´„ï¼‰ |
|---------|-----------|
| è¨˜æ†¶é«”éš¨æ©Ÿå­˜å– | ~100ns |
| ç£ç¢Ÿé †åºå¯«å…¥ | ~å¹¾æ¯«ç§’ |
| ç£ç¢Ÿéš¨æ©Ÿå¯«å…¥ | ~10æ¯«ç§’+ |

```
è¦–è¦ºåŒ–ï¼š

éš¨æ©Ÿå¯«å…¥ï¼ˆå‚³çµ±è³‡æ–™åº«ï¼‰:
ç£ç¢Ÿ: [X] ... [X] ... [X] ... [X]
      â†‘è·³èºâ†‘è·³èºâ†‘è·³èº  â† ç£é ­éœ€è¦ä¸æ–·ç§»å‹•

é †åºå¯«å…¥ï¼ˆKafkaï¼‰:
ç£ç¢Ÿ: [X][X][X][X][X][X][X][X]
      â† é€£çºŒå¯«å…¥ï¼Œç£é ­ç§»å‹•æœ€å°‘
```

**å¯¦éš›æ„ç¾©**ï¼š
- Kafka çš„æ¶ˆæ¯ç¸½æ˜¯è¿½åŠ åˆ°æ—¥èªŒæ–‡ä»¶æœ«å°¾
- æ²’æœ‰éš¨æ©Ÿçš„æ’å…¥ã€æ›´æ–°ã€åˆªé™¤æ“ä½œ
- å……åˆ†ç™¼æ®ç£ç¢Ÿçš„é †åº I/O æ€§èƒ½

**é¡æ¯”**ï¼š
æƒ³åƒä½ åœ¨ç­†è¨˜æœ¬ä¸Šå¯«æ—¥è¨˜ï¼š
- **éš¨æ©Ÿå¯«å…¥**ï¼šæ¯æ¬¡éƒ½è¦ç¿»åˆ°ç‰¹å®šé é¢ä¿®æ”¹å…§å®¹ï¼ˆæ…¢ï¼‰
- **é †åºå¯«å…¥**ï¼šæ¯æ¬¡éƒ½å¯«åœ¨æœ€å¾Œä¸€é ï¼ˆå¿«ï¼‰

### 2. Zero-Copy æŠ€è¡“

**å•é¡Œ**ï¼šå‚³çµ±çš„æ•¸æ“šå‚³è¼¸éœ€è¦å¤šæ¬¡è¤‡è£½ã€‚

**å‚³çµ±æ–¹å¼** âŒ

```
1. å¾ç£ç¢Ÿè®€å–æ•¸æ“šåˆ°ä½œæ¥­ç³»çµ±å…§æ ¸ç·©è¡å€
2. å¾å…§æ ¸ç·©è¡å€è¤‡è£½åˆ°æ‡‰ç”¨ç¨‹å¼ç·©è¡å€
3. å¾æ‡‰ç”¨ç¨‹å¼ç·©è¡å€è¤‡è£½åˆ°å…§æ ¸ Socket ç·©è¡å€
4. å¾ Socket ç·©è¡å€ç™¼é€åˆ°ç¶²è·¯å¡

ç¸½å…±ï¼š4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ› + 4 æ¬¡æ•¸æ“šè¤‡è£½
```

**Kafka çš„ Zero-Copy** âœ…

```
1. å¾ç£ç¢Ÿè®€å–æ•¸æ“šåˆ°å…§æ ¸ç·©è¡å€
2. ç›´æ¥å¾å…§æ ¸ç·©è¡å€ç™¼é€åˆ°ç¶²è·¯å¡

ç¸½å…±ï¼š2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ› + 2 æ¬¡æ•¸æ“šè¤‡è£½ï¼ˆç”šè‡³æ›´å°‘ï¼‰
```

**è¦–è¦ºåŒ–**ï¼š

```
å‚³çµ±æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â‘¡  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â‘¢  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â‘£  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç£ç¢Ÿ  â”‚ â”€â”€â”€â†’â”‚ Kernel â”‚ â”€â”€â”€â†’â”‚  App   â”‚ â”€â”€â”€â†’â”‚ Socket â”‚ â”€â”€â”€â†’â”‚  ç¶²è·¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Zero-Copyï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â‘¡  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç£ç¢Ÿ  â”‚ â”€â”€â”€â†’â”‚ Kernel â”‚ â”€â”€â”€â†’â”‚  ç¶²è·¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (ç›´æ¥å‚³è¼¸ï¼Œç„¡éœ€ç¶“éæ‡‰ç”¨å±¤)
```

**å¯¦éš›å½±éŸ¿**ï¼š
- æ¸›å°‘ CPU ä½¿ç”¨ç‡
- æ¸›å°‘è¨˜æ†¶é«”é »å¯¬æ¶ˆè€—
- å¤§å¹…æå‡ååé‡

### 3. æ‰¹æ¬¡è™•ç†ï¼ˆBatchingï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šæ‰¹é‡è™•ç†æ¯”å–®æ¢è™•ç†æ›´é«˜æ•ˆã€‚

**å–®æ¢è™•ç†** âŒ
```
ç™¼é€ 1000 æ¢æ¶ˆæ¯ï¼š
ç¶²è·¯è«‹æ±‚ Ã— 1000 = å¾ˆå¤šæ¬¡ç¶²è·¯é–‹éŠ·
```

**æ‰¹æ¬¡è™•ç†** âœ…
```
ç™¼é€ 1000 æ¢æ¶ˆæ¯ï¼š
å°‡ 100 æ¢æ‰“åŒ…æˆä¸€æ‰¹ Ã— 10 æ¬¡ = æ¸›å°‘ç¶²è·¯é–‹éŠ·
```

**è¦–è¦ºåŒ–**ï¼š

```
å–®æ¢è™•ç†ï¼š
Producer: [msg] [msg] [msg] [msg] [msg] ...
              â†“    â†“    â†“    â†“    â†“
ç¶²è·¯è«‹æ±‚:      1    2    3    4    5    ... (1000æ¬¡)

æ‰¹æ¬¡è™•ç†ï¼š
Producer: [msg+msg+msg+...] [msg+msg+msg+...] ...
                 â†“                 â†“
ç¶²è·¯è«‹æ±‚:          1                 2          ... (10æ¬¡)
```

**Kafka çš„æ‰¹æ¬¡ç­–ç•¥**ï¼š

1. **Producer ç«¯æ‰¹æ¬¡**ï¼š
   - ç´¯ç©ä¸€å®šæ•¸é‡çš„æ¶ˆæ¯å¾Œå†ç™¼é€
   - æˆ–ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œç™¼é€
   - å¯é…ç½®ï¼š`batch.size`ã€`linger.ms`

2. **Broker ç«¯æ‰¹æ¬¡**ï¼š
   - æ‰¹é‡å¯«å…¥ç£ç¢Ÿ
   - æ‰¹é‡éŸ¿æ‡‰ Consumer

**æ¬Šè¡¡**ï¼š
- âœ… å„ªé»ï¼šæé«˜ååé‡ã€æ¸›å°‘ç¶²è·¯é–‹éŠ·
- âš ï¸ ç¼ºé»ï¼šå¢åŠ å»¶é²ï¼ˆéœ€è¦ç­‰å¾…æ¹Šæ‰¹ï¼‰

**é…ç½®ç¤ºä¾‹**ï¼š
```typescript
// é«˜ååé‡é…ç½®ï¼ˆè¼ƒå¤§å»¶é²ï¼‰
{
  batchSize: 32768,    // 32KB
  lingerMs: 10         // ç­‰å¾… 10ms
}

// ä½å»¶é²é…ç½®ï¼ˆè¼ƒä½ååé‡ï¼‰
{
  batchSize: 1024,     // 1KB
  lingerMs: 0          // ä¸ç­‰å¾…
}
```

### 4. æ¶ˆæ¯å£“ç¸®ï¼ˆCompressionï¼‰

**ç›®çš„**ï¼šæ¸›å°‘ç¶²è·¯å‚³è¼¸å’Œç£ç¢Ÿå­˜å„²çš„æ•¸æ“šé‡ã€‚

**æ”¯æŒçš„å£“ç¸®ç®—æ³•**ï¼š

| ç®—æ³• | å£“ç¸®ç‡ | CPU ä½¿ç”¨ | é©ç”¨å ´æ™¯ |
|------|--------|---------|---------|
| **gzip** | é«˜ | é«˜ | ç¶²è·¯é »å¯¬æœ‰é™ |
| **snappy** | ä¸­ | ä½ | å¹³è¡¡æ€§èƒ½ |
| **lz4** | ä¸­ | å¾ˆä½ | ä½å»¶é²è¦æ±‚ |
| **zstd** | é«˜ | ä¸­ | æ–°æ¨è–¦é¸æ“‡ |

**å·¥ä½œæ©Ÿåˆ¶**ï¼š

```
Producer ç«¯ï¼š
[msg1][msg2][msg3]... â†’ å£“ç¸® â†’ [compressed data]
                                      â†“
                                  ç™¼é€åˆ° Broker

Broker ç«¯ï¼š
ä¿æŒå£“ç¸®ç‹€æ…‹å­˜å„²

Consumer ç«¯ï¼š
æ¥æ”¶ [compressed data] â†’ è§£å£“ç¸® â†’ [msg1][msg2][msg3]...
```

**é‡è¦ç‰¹æ€§**ï¼š
- å£“ç¸®æ˜¯**æ‰¹æ¬¡ç´šåˆ¥**çš„ï¼ˆä¸æ˜¯å–®æ¢æ¶ˆæ¯ï¼‰
- Broker **ä¸è§£å£“ç¸®**ï¼ˆä¿æŒåŸæ¨£å­˜å„²å’Œè½‰ç™¼ï¼‰
- ç¯€çœç£ç¢Ÿç©ºé–“å’Œç¶²è·¯é »å¯¬

**ä½•æ™‚ä½¿ç”¨å£“ç¸®**ï¼š
- âœ… æ¶ˆæ¯å…§å®¹é‡è¤‡æ€§é«˜ï¼ˆå¦‚ JSONã€æ–‡æœ¬ï¼‰
- âœ… ç¶²è·¯é »å¯¬æœ‰é™
- âš ï¸ éœ€è¦æ›´å¤š CPU è³‡æº
- âŒ æ¶ˆæ¯å·²ç¶“æ˜¯å£“ç¸®æ ¼å¼ï¼ˆå¦‚åœ–ç‰‡ã€è¦–é »ï¼‰

### 5. é ç·©å­˜ï¼ˆPage Cacheï¼‰

**Kafka çš„ç­–ç•¥**ï¼šä¾è³´ä½œæ¥­ç³»çµ±çš„é ç·©å­˜ï¼Œè€Œä¸æ˜¯è‡ªå·±ç®¡ç†è¨˜æ†¶é«”ã€‚

**å‚³çµ± Java æ‡‰ç”¨** âŒ
```
è‡ªå·±ç¶­è­· in-memory cache
â†“
éœ€è¦ç®¡ç† JVM Heap
â†“
å¯èƒ½è§¸ç™¼ GCï¼ˆGarbage Collectionï¼‰
â†“
GC æš«åœå½±éŸ¿æ€§èƒ½
```

**Kafka çš„åšæ³•** âœ…
```
ç›´æ¥å¯«å…¥ç£ç¢Ÿ
â†“
ä½œæ¥­ç³»çµ±è‡ªå‹•å°‡ç†±æ•¸æ“šç·©å­˜åœ¨è¨˜æ†¶é«”ï¼ˆPage Cacheï¼‰
â†“
è®€å–æ™‚å¦‚æœåœ¨ Page Cache ä¸­ï¼Œé€Ÿåº¦ç­‰åŒæ–¼è¨˜æ†¶é«”è®€å–
â†“
ç„¡ GC å•é¡Œ
```

**è¦–è¦ºåŒ–**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ä½œæ¥­ç³»çµ±è¨˜æ†¶é«”                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      Page Cache             â”‚    â”‚ â† ä½œæ¥­ç³»çµ±è‡ªå‹•ç®¡ç†
â”‚  â”‚  [æœ€è¿‘çš„æ¶ˆæ¯æ•¸æ“šè¢«ç·©å­˜åœ¨é€™è£¡] â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• (å¿«é€Ÿå­˜å–)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ç£ç¢Ÿ                      â”‚
â”‚   [æ‰€æœ‰æ¶ˆæ¯æŒä¹…åŒ–å­˜å„²]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„ªå‹¢**ï¼š
- é‡å•Ÿå¾Œç·©å­˜ä»åœ¨ï¼ˆä½œæ¥­ç³»çµ± Page Cacheï¼‰
- ç„¡ GC å•é¡Œ
- å……åˆ†åˆ©ç”¨å¯ç”¨è¨˜æ†¶é«”

## åˆ†å€èˆ‡ä¸¦è¡Œè™•ç†

### ç‚ºä»€éº¼åˆ†å€æ˜¯ Kafka çš„æ ¸å¿ƒ

**å–®åˆ†å€çš„é™åˆ¶**ï¼š
```
Topic (1 å€‹åˆ†å€)
     â†“
åªèƒ½æœ‰ 1 å€‹ Consumer è™•ç†
     â†“
ååé‡å—é™æ–¼å–®å€‹ Consumer çš„è™•ç†èƒ½åŠ›
```

**å¤šåˆ†å€çš„å¨åŠ›**ï¼š
```
Topic (4 å€‹åˆ†å€)
  â†™  â†“  â†“  â†˜
C1  C2  C3  C4  (4 å€‹ Consumers)
     â†“
ååé‡ = å–®å€‹ Consumer Ã— 4
```

### åˆ†å€çš„å¯¦ç¾

**æ•¸æ“šçµæ§‹**ï¼š

æ¯å€‹åˆ†å€æ˜¯ä¸€å€‹**æœ‰åºçš„ã€ä¸å¯è®Šçš„æ¶ˆæ¯åºåˆ—**ã€‚

```
Partition ç‰©ç†å­˜å„²ï¼š

/kafka-logs/topic-name-0/
  â”œâ”€â”€ 00000000000000000000.log    (æ¶ˆæ¯æ•¸æ“š)
  â”œâ”€â”€ 00000000000000000000.index  (offset ç´¢å¼•)
  â”œâ”€â”€ 00000000000000000000.timeindex (æ™‚é–“ç´¢å¼•)
  â”œâ”€â”€ 00000000000000100000.log
  â”œâ”€â”€ 00000000000000100000.index
  â””â”€â”€ ...

æ¯å€‹ .log æ–‡ä»¶æ˜¯ä¸€å€‹ segmentï¼ˆæ®µï¼‰
```

**Segment**ï¼š
- åˆ†å€è¢«åˆ‡åˆ†æˆå¤šå€‹ segment
- æ¯å€‹ segment ç´„ 1GBï¼ˆå¯é…ç½®ï¼‰
- èˆŠçš„ segment å¯ä»¥è¢«åˆªé™¤æˆ–å£“ç¸®

### åˆ†å€çš„åˆ†é…ç­–ç•¥

**Producer å¦‚ä½•é¸æ“‡åˆ†å€ï¼Ÿ**

```typescript
// æƒ…æ³ 1: æœ‰æŒ‡å®š key
partition = hash(key) % åˆ†å€æ•¸
// ç›¸åŒ key â†’ ç›¸åŒåˆ†å€ â†’ ä¿è­‰é †åº

// æƒ…æ³ 2: æ²’æœ‰ key
partition = round-robin æˆ– sticky partitioner
// å‡å‹»åˆ†å¸ƒåˆ°å„åˆ†å€

// æƒ…æ³ 3: è‡ªå®šç¾© partitioner
partition = customPartitioner(key, value, åˆ†å€æ•¸)
```

**ç¤ºä¾‹**ï¼š

```typescript
// å ´æ™¯ï¼šè¨‚å–®ç³»çµ±ï¼Œéœ€è¦ä¿è­‰åŒä¸€ç”¨æˆ¶çš„è¨‚å–®æœ‰åº

// ä½¿ç”¨ userId ä½œç‚º key
await producer.send({
  topic: 'orders',
  messages: [{
    key: 'user-12345',  // ç›¸åŒç”¨æˆ¶çš„æ‰€æœ‰è¨‚å–®éƒ½æœƒåˆ°åŒä¸€åˆ†å€
    value: JSON.stringify(orderData)
  }]
});
```

### ä¸¦è¡Œè™•ç†çš„é™åˆ¶

**é‡è¦è¦å‰‡**ï¼š

```
Consumer Group ä¸­ï¼š
- æ¯å€‹åˆ†å€åªèƒ½è¢«ä¸€å€‹ Consumer æ¶ˆè²»
- ä¸€å€‹ Consumer å¯ä»¥æ¶ˆè²»å¤šå€‹åˆ†å€
```

**ä¸åŒé…ç½®çš„æ•ˆæœ**ï¼š

```
å ´æ™¯ 1: åˆ†å€æ•¸ = Consumer æ•¸
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ P0   â”‚  â”‚ P1   â”‚  â”‚ P2   â”‚  â”‚ P3   â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚         â”‚         â”‚         â”‚
   â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ C0   â”‚  â”‚ C1   â”‚  â”‚ C2   â”‚  â”‚ C3   â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
âœ… ç†æƒ³é…ç½®ï¼šå……åˆ†ä¸¦è¡Œ

å ´æ™¯ 2: åˆ†å€æ•¸ > Consumer æ•¸
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ P0   â”‚  â”‚ P1   â”‚  â”‚ P2   â”‚  â”‚ P3   â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚         â”‚         â”‚         â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â–¼                   â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚ C0   â”‚            â”‚ C1   â”‚
     â””â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”˜
âœ… å¯è¡Œï¼šéƒ¨åˆ† Consumer è™•ç†å¤šå€‹åˆ†å€

å ´æ™¯ 3: åˆ†å€æ•¸ < Consumer æ•¸
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ P0   â”‚  â”‚ P1   â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚         â”‚
   â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ C0   â”‚  â”‚ C1   â”‚  â”‚ C2   â”‚  â”‚ C3   â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
                      â†‘         â†‘
                      ç©ºé–’      ç©ºé–’
âš ï¸ æµªè²»ï¼šéƒ¨åˆ† Consumer é–’ç½®
```

## æŒä¹…åŒ–èˆ‡å¯é æ€§

### æŒä¹…åŒ–ç­–ç•¥

**Kafka çš„æ‰¿è«¾**ï¼š
```
æ¶ˆæ¯å¯«å…¥ Kafka å¾Œ â†’ æŒä¹…åŒ–åˆ°ç£ç¢Ÿ â†’ ä¸æœƒä¸Ÿå¤±ï¼ˆé™¤éç£ç¢Ÿæå£ï¼‰
```

**å‰¯æœ¬æ©Ÿåˆ¶**ï¼š

```
Topic: orders, Partition 0, Replication Factor: 3

Broker 1        Broker 2        Broker 3
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leader   â”‚â”€â”€â”€â†’â”‚ Follower â”‚    â”‚ Follower â”‚
â”‚ P0       â”‚    â”‚ P0       â”‚â†â”€â”€â”€â”‚ P0       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘               â†‘               â†‘
  å¯«å…¥é€™è£¡        åŒæ­¥å‰¯æœ¬        åŒæ­¥å‰¯æœ¬
```

**Leader èˆ‡ Follower**ï¼š
- **Leader**ï¼šè™•ç†æ‰€æœ‰è®€å¯«è«‹æ±‚
- **Follower**ï¼šå¾ Leader åŒæ­¥æ•¸æ“šï¼Œä½œç‚ºå‚™ä»½

**ISRï¼ˆIn-Sync Replicasï¼‰**ï¼š
- èˆ‡ Leader ä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆ
- åªæœ‰ ISR ä¸­çš„å‰¯æœ¬å¯ä»¥è¢«é¸ç‚ºæ–° Leader

### å¯é æ€§ç­‰ç´š

**Producer çš„ acks é…ç½®**ï¼š

```typescript
// acks = 0: ä¸ç­‰å¾…ç¢ºèªï¼ˆæœ€å¿«ï¼Œå¯èƒ½ä¸Ÿå¤±ï¼‰
{
  acks: 0
}
// Producer ç™¼é€å¾Œç«‹å³è¿”å›
// é¢¨éšªï¼šå¦‚æœç¶²è·¯æ•…éšœæˆ– Broker æ›äº†ï¼Œæ¶ˆæ¯ä¸Ÿå¤±

// acks = 1: ç­‰å¾… Leader ç¢ºèªï¼ˆå¹³è¡¡ï¼‰
{
  acks: 1
}
// Leader å¯«å…¥æˆåŠŸå¾Œè¿”å›
// é¢¨éšªï¼šLeader æ›äº†ä½† Follower é‚„æ²’åŒæ­¥ï¼Œæ¶ˆæ¯å¯èƒ½ä¸Ÿå¤±

// acks = all/-1: ç­‰å¾…æ‰€æœ‰ ISR ç¢ºèªï¼ˆæœ€å¯é ï¼‰
{
  acks: -1
}
// æ‰€æœ‰ ISR å‰¯æœ¬éƒ½å¯«å…¥æˆåŠŸå¾Œæ‰è¿”å›
// æœ€å®‰å…¨ï¼Œä½†å»¶é²æœ€é«˜
```

**æ¬Šè¡¡**ï¼š

| acks | é€Ÿåº¦ | å¯é æ€§ | ä½¿ç”¨å ´æ™¯ |
|------|------|--------|---------|
| 0 | æœ€å¿« | æœ€ä½ | æ—¥èªŒã€æŒ‡æ¨™ï¼ˆå…è¨±å°‘é‡ä¸Ÿå¤±ï¼‰ |
| 1 | å¿« | ä¸­ | å¤§å¤šæ•¸å ´æ™¯ |
| all | æ…¢ | æœ€é«˜ | é‡‘èäº¤æ˜“ã€è¨‚å–®ï¼ˆä¸èƒ½ä¸Ÿå¤±ï¼‰ |

## å¯æ“´å±•æ€§è¨­è¨ˆ

### æ°´å¹³æ“´å±•

**Broker æ“´å±•**ï¼š

```
åˆå§‹ï¼š1 å€‹ Broker
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Broker 1      â”‚
â”‚  P0 P1 P2 P3     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ“´å±•å¾Œï¼š3 å€‹ Broker
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Broker 1â”‚  â”‚Broker 2â”‚  â”‚Broker 3â”‚
â”‚ P0 P3  â”‚  â”‚ P1     â”‚  â”‚ P2     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†å€æ“´å±•**ï¼š

```
# å¢åŠ åˆ†å€æ•¸é‡
kafka-topics --alter \
  --topic orders \
  --partitions 10
```

âš ï¸ **æ³¨æ„**ï¼š
- å¯ä»¥å¢åŠ åˆ†å€ï¼Œä½†ä¸å»ºè­°æ¸›å°‘
- å¢åŠ åˆ†å€å¾Œï¼Œkey çš„åˆ†é…å¯èƒ½æ”¹è®Š
- æ­·å²æ•¸æ“šä¸æœƒé‡æ–°åˆ†é…

### å½ˆæ€§èˆ‡å®¹éŒ¯

**Broker æ•…éšœè™•ç†**ï¼š

```
æ­£å¸¸æƒ…æ³ï¼š
Broker 1 (Leader-P0)    Broker 2 (Follower-P0)
     â†“                         â†“
  è™•ç†è«‹æ±‚                  åŒæ­¥æ•¸æ“š

Broker 1 æ•…éšœï¼š
Broker 1 (X)            Broker 2 (Leader-P0)
                              â†“
                         è‡ªå‹•æå‡ç‚º Leader
                              â†“
                         ç¹¼çºŒè™•ç†è«‹æ±‚
```

**è‡ªå‹•æ¢å¾©**ï¼š
- Controller æª¢æ¸¬åˆ° Broker æ•…éšœ
- å¾ ISR ä¸­é¸èˆ‰æ–° Leader
- æ›´æ–°å…ƒæ•¸æ“š
- å®¢æˆ¶ç«¯è‡ªå‹•é€£æ¥åˆ°æ–° Leader

## è¨­è¨ˆå“²å­¸ç¸½çµ

Kafka çš„é«˜æ€§èƒ½ä¾†è‡ªæ–¼ï¼š

```
é †åºå¯«å…¥  â”â”â”“
Zero-Copy â”â”â”«
æ‰¹æ¬¡è™•ç†  â”â”â”«â”â”â†’ æ¥µè‡´æ€§èƒ½
æ¶ˆæ¯å£“ç¸®  â”â”â”«
é ç·©å­˜    â”â”â”›

åˆ†å€æ©Ÿåˆ¶  â”â”â”“
ä¸¦è¡Œè™•ç†  â”â”â”«â”â”â†’ å¯æ“´å±•æ€§
æ°´å¹³æ“´å±•  â”â”â”›

å‰¯æœ¬æ©Ÿåˆ¶  â”â”â”“
æŒä¹…åŒ–    â”â”â”«â”â”â†’ å¯é æ€§
ISR       â”â”â”›
```

**æ ¸å¿ƒç†å¿µ**ï¼š
1. **ç°¡å–®å³æ˜¯ç¾**ï¼šæ—¥èªŒçµæ§‹ç°¡å–®ä½†å¼·å¤§
2. **ä¾è³´ç³»çµ±è³‡æº**ï¼šå–„ç”¨ä½œæ¥­ç³»çµ±ç‰¹æ€§è€Œä¸æ˜¯é‡æ–°ç™¼æ˜è¼ªå­
3. **æ‰¹æ¬¡å„ªæ–¼å–®æ¢**ï¼šæ‰¹é‡è™•ç†æé«˜æ•ˆç‡
4. **ç•°æ­¥å„ªæ–¼åŒæ­¥**ï¼šæ¸›å°‘é˜»å¡ï¼Œæé«˜ååé‡

## å°çµ

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘å€‘æ·±å…¥äº†è§£äº† Kafka çš„è¨­è¨ˆå“²å­¸ï¼š

1. **æ€§èƒ½å„ªåŒ–**ï¼š
   - é †åºå¯«å…¥ç£ç¢Ÿ
   - Zero-Copy æŠ€è¡“
   - æ‰¹æ¬¡è™•ç†
   - æ¶ˆæ¯å£“ç¸®
   - é ç·©å­˜

2. **ä¸¦è¡Œè™•ç†**ï¼š
   - åˆ†å€æ˜¯ä¸¦è¡Œçš„åŸºç¤
   - åˆç†çš„åˆ†å€æ•¸é‡å¾ˆé‡è¦

3. **å¯é æ€§**ï¼š
   - å‰¯æœ¬æ©Ÿåˆ¶
   - ISR åŒæ­¥
   - å¯é…ç½®çš„å¯é æ€§ç­‰ç´š

4. **å¯æ“´å±•æ€§**ï¼š
   - æ°´å¹³æ“´å±• Broker
   - å‹•æ…‹å¢åŠ åˆ†å€
   - è‡ªå‹•æ•…éšœæ¢å¾©

## æ€è€ƒé¡Œ

1. ç‚ºä»€éº¼ Kafka é¸æ“‡ä¾è³´ä½œæ¥­ç³»çµ±çš„ Page Cacheï¼Œè€Œä¸æ˜¯è‡ªå·±ç®¡ç†è¨˜æ†¶é«”ç·©å­˜ï¼Ÿ
2. åœ¨ä»€éº¼æƒ…æ³ä¸‹ï¼Œä½ æœƒé¸æ“‡ `acks=0`ï¼Ÿä»€éº¼æƒ…æ³ä¸‹é¸æ“‡ `acks=all`ï¼Ÿ
3. å¦‚æœä½ çš„æ‡‰ç”¨éœ€è¦åš´æ ¼çš„å…¨å±€é †åºï¼ˆä¸åªæ˜¯åˆ†å€å…§é †åºï¼‰ï¼Œæ‡‰è©²å¦‚ä½•é…ç½® Kafkaï¼Ÿ

## ä¸‹ä¸€æ­¥

ç¾åœ¨ä½ å·²ç¶“ç†è§£äº† Kafka ç‚ºä»€éº¼å¦‚æ­¤é«˜æ•ˆã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å‹•æ‰‹æ­å»º Kafka ç’°å¢ƒï¼Œé–‹å§‹å¯¦éš›æ“ä½œã€‚

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼š04 - ç’°å¢ƒæ­å»ºèˆ‡åŸºæœ¬æ“ä½œ](../04-environment-setup/README.md)

---

[è¿”å›ç›®éŒ„](../README.md)

