# 13 - æ•¸æ“šå­˜å„²èˆ‡æ—¥èªŒ

## å­¸ç¿’ç›®æ¨™

- ç†è§£ Kafka çš„å­˜å„²çµæ§‹
- æŒæ¡æ—¥èªŒæ®µï¼ˆLog Segmentï¼‰æ©Ÿåˆ¶
- äº†è§£ç´¢å¼•çš„ä½œç”¨
- ç†è§£æ•¸æ“šä¿ç•™å’Œæ¸…ç†ç­–ç•¥

## Kafka çš„å­˜å„²çµæ§‹

### ç›®éŒ„çµæ§‹

```
/var/kafka-logs/                 â† log.dirs é…ç½®çš„ç›®éŒ„
â”œâ”€â”€ topic-name-0/                â† Topic: topic-name, Partition: 0
â”‚   â”œâ”€â”€ 00000000000000000000.log        â† Segment æ–‡ä»¶
â”‚   â”œâ”€â”€ 00000000000000000000.index      â† Offset ç´¢å¼•
â”‚   â”œâ”€â”€ 00000000000000000000.timeindex  â† æ™‚é–“ç´¢å¼•
â”‚   â”œâ”€â”€ 00000000000000100000.log        â† ä¸‹ä¸€å€‹ Segment
â”‚   â”œâ”€â”€ 00000000000000100000.index
â”‚   â”œâ”€â”€ 00000000000000100000.timeindex
â”‚   â””â”€â”€ leader-epoch-checkpoint         â† Leader Epoch æ–‡ä»¶
â”œâ”€â”€ topic-name-1/                â† Partition: 1
â”‚   â””â”€â”€ ...
â””â”€â”€ topic-name-2/                â† Partition: 2
    â””â”€â”€ ...
```

### åˆ†å€ = æ—¥èªŒï¼ˆLogï¼‰

```
Partition åœ¨ç£ç¢Ÿä¸Šå°±æ˜¯ä¸€å€‹ç›®éŒ„ï¼š

topic-orders-0/
    â†“
å¤šå€‹ Segment æ–‡ä»¶ï¼ˆæŒ‰é †åºè¿½åŠ ï¼‰

æ¯å€‹ Segmentï¼š
- .log æ–‡ä»¶ï¼šå¯¦éš›çš„æ¶ˆæ¯æ•¸æ“š
- .index æ–‡ä»¶ï¼šoffset â†’ æ–‡ä»¶ä½ç½®çš„æ˜ å°„
- .timeindex æ–‡ä»¶ï¼štimestamp â†’ offsetçš„æ˜ å°„
```

## æ—¥èªŒæ®µï¼ˆLog Segmentï¼‰

### ä»€éº¼æ˜¯ Segmentï¼Ÿ

```
Partition è¢«åˆ†æˆå¤šå€‹ Segmentï¼š

Partition 0:
â”œâ”€â”€ Segment 0    (offset 0 - 99999)
â”œâ”€â”€ Segment 1    (offset 100000 - 199999)
â”œâ”€â”€ Segment 2    (offset 200000 - 299999)  â† Active Segment
â””â”€â”€ ...

åªæœ‰æœ€å¾Œä¸€å€‹ Segment æ˜¯ã€ŒActiveã€ï¼ˆå¯å¯«å…¥ï¼‰
å…¶ä»– Segment æ˜¯ã€ŒClosedã€ï¼ˆåªè®€ï¼‰
```

### ç‚ºä»€éº¼éœ€è¦ Segmentï¼Ÿ

1. **åŠ å¿«å•Ÿå‹•é€Ÿåº¦**ï¼šä¸éœ€è¦ä¸€æ¬¡æ€§è¼‰å…¥æ•´å€‹åˆ†å€
2. **ä¾¿æ–¼æ¸…ç†**ï¼šåˆªé™¤èˆŠ Segment æ–‡ä»¶
3. **ä¾¿æ–¼å£“ç¸®**ï¼šå°èˆŠ Segment é€²è¡Œå£“ç¸®
4. **é™åˆ¶å–®æ–‡ä»¶å¤§å°**ï¼šé¿å…æ–‡ä»¶éå¤§

### Segment æ»¾å‹•æ¢ä»¶

```properties
# é…ç½®æ–‡ä»¶ï¼šserver.properties

# æ¢ä»¶ 1ï¼šå¤§å°è¶…éé–¾å€¼ï¼ˆé»˜èª 1GBï¼‰
log.segment.bytes=1073741824

# æ¢ä»¶ 2ï¼šæ™‚é–“è¶…éé–¾å€¼ï¼ˆé»˜èª 7 å¤©ï¼‰
log.segment.ms=604800000

# æ¢ä»¶ 3ï¼šç´¢å¼•æ–‡ä»¶æ»¿äº†
log.index.size.max.bytes=10485760
```

ç•¶ä»»ä¸€æ¢ä»¶æ»¿è¶³ï¼Œå‰µå»ºæ–° Segmentã€‚

### Segment æ–‡ä»¶å‘½å

```
æ–‡ä»¶å = è©² Segment çš„èµ·å§‹ offsetï¼ˆ20 ä½ï¼Œè£œé›¶ï¼‰

ä¾‹å¦‚ï¼š
00000000000000000000.log    â† offset 0 é–‹å§‹
00000000000000100000.log    â† offset 100000 é–‹å§‹
00000000000000200000.log    â† offset 200000 é–‹å§‹
```

## æ¶ˆæ¯æ ¼å¼

### æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­çš„çµæ§‹

```
å–®æ¢æ¶ˆæ¯ï¼ˆRecordï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Offset (8 bytes)               â”‚ â† offset
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Message Size (4 bytes)         â”‚ â† æ¶ˆæ¯å¤§å°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CRC (4 bytes)                  â”‚ â† æ ¡é©—å’Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Magic (1 byte)                 â”‚ â† ç‰ˆæœ¬è™Ÿ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Attributes (1 byte)            â”‚ â† å£“ç¸®é¡å‹ç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Timestamp (8 bytes)            â”‚ â† æ™‚é–“æˆ³
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Key Length (4 bytes)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Key (variable)                 â”‚ â† Key æ•¸æ“š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Value Length (4 bytes)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Value (variable)               â”‚ â† Value æ•¸æ“š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Headers (variable)             â”‚ â† Headers
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰¹æ¬¡ï¼ˆBatchï¼‰

Kafka å¯¦éš›ä¸Šæ˜¯ä»¥æ‰¹æ¬¡ï¼ˆBatchï¼‰ç‚ºå–®ä½å¯«å…¥çš„ï¼š

```
Batch:
  Header:
    - Base Offset
    - Batch Length
    - CRC
    - Compression Type
    - Timestamp
    - ...
  Records:
    - Record 1
    - Record 2
    - ...
```

## ç´¢å¼•æ©Ÿåˆ¶

### Offset Index

**ä½œç”¨**ï¼šæ ¹æ“š offset å¿«é€Ÿå®šä½åˆ°æ–‡ä»¶ä½ç½®

```
00000000000000100000.index:

offset â†’ position
100000 â†’ 0
100100 â†’ 5432
100200 â†’ 10864
...

ç¨€ç–ç´¢å¼•ï¼ˆä¸æ˜¯æ¯æ¢æ¶ˆæ¯éƒ½æœ‰ç´¢å¼•é …ï¼‰
```

### Time Index

**ä½œç”¨**ï¼šæ ¹æ“šæ™‚é–“æˆ³å¿«é€Ÿå®šä½åˆ° offset

```
00000000000000100000.timeindex:

timestamp â†’ offset
1609459200000 â†’ 100000
1609462800000 â†’ 100500
1609466400000 â†’ 101000
...
```

### æŸ¥æ‰¾éç¨‹

```
æŸ¥æ‰¾ offset 150000 çš„æ¶ˆæ¯ï¼š

1. äºŒåˆ†æŸ¥æ‰¾ Segment:
   - 00000000000000000000.log (0-99999)
   - 00000000000000100000.log (100000-199999) âœ“ å‘½ä¸­
   - 00000000000000200000.log (200000-299999)

2. è®€å– index æ–‡ä»¶ï¼š
   100000 â†’ 0
   100100 â†’ 5432
   100200 â†’ 10864
   ...
   150000 â†’ 267890 âœ“

3. å¾ position 267890 é–‹å§‹é †åºè®€å–åˆ° offset 150000
```

## æ•¸æ“šä¿ç•™ç­–ç•¥

### ç­–ç•¥ 1ï¼šåŸºæ–¼æ™‚é–“

```properties
# ä¿ç•™ 7 å¤©
log.retention.hours=168

# æˆ–æ›´ç²¾ç¢º
log.retention.ms=604800000

åˆªé™¤é‚è¼¯ï¼š
if (segmentæœ€å¾Œä¿®æ”¹æ™‚é–“ + retentionæ™‚é–“ < ç•¶å‰æ™‚é–“):
    åˆªé™¤è©² segment
```

### ç­–ç•¥ 2ï¼šåŸºæ–¼å¤§å°

```properties
# æ¯å€‹åˆ†å€æœ€å¤šä¿ç•™ 10GB
log.retention.bytes=10737418240

åˆªé™¤é‚è¼¯ï¼š
if (åˆ†å€ç¸½å¤§å° > retention.bytes):
    åˆªé™¤æœ€èˆŠçš„ segment
```

### ç­–ç•¥ 3ï¼šLog Compaction

**é©ç”¨å ´æ™¯**ï¼šéœ€è¦ä¿ç•™æ¯å€‹ Key çš„æœ€æ–°å€¼ï¼ˆå¦‚æ•¸æ“šåº«è®Šæ›´æ—¥èªŒï¼‰

```properties
log.cleanup.policy=compact
```

**å·¥ä½œåŸç†**ï¼š

```
åŸå§‹æ—¥èªŒï¼š
offset  key  value
0       A    1
1       B    2
2       A    3      â† A çš„æ–°å€¼
3       C    4
4       B    5      â† B çš„æ–°å€¼

å£“ç¸®å¾Œï¼š
offset  key  value
2       A    3      â† ä¿ç•™ A çš„æœ€æ–°å€¼
3       C    4      â† C åªæœ‰ä¸€å€‹å€¼
4       B    5      â† ä¿ç•™ B çš„æœ€æ–°å€¼

Key ç‚º null çš„æ¶ˆæ¯æœƒè¢«åˆªé™¤ï¼ˆå¢“ç¢‘æ¶ˆæ¯ï¼‰
```

**é…ç½®**ï¼š

```properties
# å•Ÿç”¨å£“ç¸®
log.cleanup.policy=compact

# å£“ç¸®é »ç‡
log.cleaner.min.cleanable.ratio=0.5

# æœ€å°ä¿ç•™æ™‚é–“ï¼ˆå³ä½¿å£“ç¸®ä¹Ÿä¿ç•™ï¼‰
log.cleaner.min.compaction.lag.ms=60000
```

## æ•¸æ“šæ¸…ç†

### åˆªé™¤ï¼ˆDeleteï¼‰

```bash
# é»˜èªæ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
log.retention.check.interval.ms=300000

æ¸…ç†éç¨‹ï¼š
1. å¾Œå°ç·šç¨‹å®šæœŸæª¢æŸ¥
2. æ‰¾å‡ºéæœŸçš„ Segment
3. åˆªé™¤ .log, .index, .timeindex æ–‡ä»¶
```

### å£“ç¸®ï¼ˆCompactï¼‰

```bash
# Log Cleaner ç·šç¨‹æ•¸
log.cleaner.threads=1

å£“ç¸®éç¨‹ï¼š
1. é¸æ“‡éœ€è¦å£“ç¸®çš„ Segment
2. æ§‹å»º Key çš„å“ˆå¸Œè¡¨
3. æƒæ Segmentï¼Œä¿ç•™æ¯å€‹ Key çš„æœ€æ–°å€¼
4. å¯«å…¥æ–°çš„ Segment
5. æ›¿æ›èˆŠ Segment
```

## æ€§èƒ½å„ªåŒ–

### é…ç½®å»ºè­°

```properties
# 1. Segment å¤§å°
# è¼ƒå¤§çš„ Segmentï¼šæ¸›å°‘æ–‡ä»¶æ•¸é‡ï¼Œä½†åˆªé™¤/å£“ç¸®æ…¢
# è¼ƒå°çš„ Segmentï¼šæ›´å¿«æ¸…ç†ï¼Œä½†æ–‡ä»¶æ•¸é‡å¤š
log.segment.bytes=1073741824  # 1GBï¼ˆé»˜èªï¼‰

# 2. Flush ç­–ç•¥
# ä¾è³´ä½œæ¥­ç³»çµ± Page Cacheï¼Œä¸é »ç¹ flush
log.flush.interval.messages=9223372036854775807
log.flush.interval.ms=null

# 3. å£“ç¸®é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
compression.type=producer  # ä¿æŒ Producer çš„å£“ç¸®
```

### ç›£æ§æŒ‡æ¨™

```bash
# æŸ¥çœ‹åˆ†å€å¤§å°
du -sh /var/kafka-logs/topic-name-0/

# æŸ¥çœ‹ Segment æ•¸é‡
ls -l /var/kafka-logs/topic-name-0/ | grep .log | wc -l

# æŸ¥çœ‹æœ€è€çš„ Segment
ls -lt /var/kafka-logs/topic-name-0/*.log | tail -1
```

## å¯¦ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹ Segment è©³æƒ…
kafka-run-class kafka.tools.DumpLogSegments \
  --files /var/kafka-logs/topic-name-0/00000000000000000000.log \
  --print-data-log

# é©—è­‰ç´¢å¼•
kafka-run-class kafka.tools.DumpLogSegments \
  --files /var/kafka-logs/topic-name-0/00000000000000000000.index \
  --verify-index-only

# æŸ¥çœ‹ Topic æ•¸æ“šå¤§å°
kafka-log-dirs --describe --bootstrap-server localhost:9092 \
  --topic-list topic-name
```

## å°çµ

æœ¬ç« å­¸ç¿’äº†ï¼š

1. **å­˜å„²çµæ§‹**ï¼šç›®éŒ„ã€Segmentã€ç´¢å¼•
2. **Log Segment**ï¼šåˆ†ç‰‡ç®¡ç†ã€æ»¾å‹•æ¢ä»¶
3. **ç´¢å¼•æ©Ÿåˆ¶**ï¼šå¿«é€Ÿå®šä½æ¶ˆæ¯
4. **ä¿ç•™ç­–ç•¥**ï¼šæ™‚é–“ã€å¤§å°ã€å£“ç¸®
5. **æ€§èƒ½å„ªåŒ–**ï¼šé…ç½®å’Œç›£æ§

## ä¸‹ä¸€æ­¥

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼š14 - å¯é æ€§èˆ‡ä¸€è‡´æ€§ä¿è­‰](../14-reliability-and-consistency/README.md)

---

[è¿”å›ç›®éŒ„](../README.md)

