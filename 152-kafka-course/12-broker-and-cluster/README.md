# 12 - Broker èˆ‡é›†ç¾¤

## å­¸ç¿’ç›®æ¨™

- ç†è§£ Kafka é›†ç¾¤æ¶æ§‹
- äº†è§£ Broker çš„è§’è‰²å’Œè·è²¬
- æŒæ¡å‰¯æœ¬æ©Ÿåˆ¶
- ç†è§£ Controller çš„ä½œç”¨

## Kafka é›†ç¾¤æ¶æ§‹

### åŸºæœ¬çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kafka Cluster                          â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Broker 1 â”‚    â”‚ Broker 2 â”‚    â”‚ Broker 3 â”‚           â”‚
â”‚  â”‚ ID: 1    â”‚    â”‚ ID: 2    â”‚    â”‚ ID: 3    â”‚           â”‚
â”‚  â”‚          â”‚    â”‚          â”‚    â”‚          â”‚           â”‚
â”‚  â”‚ T1-P0 (L)â”‚    â”‚ T1-P0 (F)â”‚    â”‚ T1-P1 (L)â”‚           â”‚
â”‚  â”‚ T1-P1 (F)â”‚    â”‚ T1-P1 (F)â”‚    â”‚ T1-P2 (L)â”‚           â”‚
â”‚  â”‚ T1-P2 (F)â”‚    â”‚ T1-P2 (F)â”‚    â”‚          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                            â”‚
â”‚  L = Leader, F = Follower                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                          â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   ZooKeeper   â”‚
                  â”‚  (å…ƒæ•¸æ“šå”èª¿)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Broker çš„è·è²¬

### ä¸»è¦åŠŸèƒ½

1. **æ¥æ”¶æ¶ˆæ¯**ï¼šå¾ Producer æ¥æ”¶æ¶ˆæ¯
2. **å­˜å„²æ¶ˆæ¯**ï¼šæŒä¹…åŒ–åˆ°ç£ç¢Ÿ
3. **æœå‹™è®€å–**ï¼šéŸ¿æ‡‰ Consumer è«‹æ±‚
4. **å‰¯æœ¬ç®¡ç†**ï¼šåŒæ­¥å’Œç®¡ç†å‰¯æœ¬
5. **å…ƒæ•¸æ“šç®¡ç†**ï¼šç¶­è­· Topic å’Œ Partition ä¿¡æ¯

### Broker ID

æ¯å€‹ Broker æœ‰å”¯ä¸€çš„ IDï¼š

```
Broker é…ç½®ï¼š
broker.id=1

# æˆ–è‡ªå‹•ç”Ÿæˆ
broker.id.generation.enable=true
```

## å‰¯æœ¬æ©Ÿåˆ¶ï¼ˆReplicationï¼‰

### Leader å’Œ Follower

```
Topic: orders, Partition 0, Replication Factor: 3

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Broker 1 â”‚        â”‚Broker 2 â”‚        â”‚Broker 3 â”‚
â”‚         â”‚        â”‚         â”‚        â”‚         â”‚
â”‚ Leader  â”‚â”€â”€â”€â”€â”€â”€â”€â†’â”‚Follower â”‚        â”‚Follower â”‚
â”‚  P0     â”‚   åŒæ­¥  â”‚  P0     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”‚  P0     â”‚
â”‚         â”‚        â”‚         â”‚  åŒæ­¥   â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                  â†‘                  â†‘
     â”‚                  â”‚                  â”‚
  è®€å¯«è«‹æ±‚         åŒæ­¥æ•¸æ“š          åŒæ­¥æ•¸æ“š
```

**è¦å‰‡**ï¼š
- **Leader**ï¼šè™•ç†æ‰€æœ‰è®€å¯«è«‹æ±‚
- **Follower**ï¼šå¾ Leader åŒæ­¥æ•¸æ“šï¼Œä½œç‚ºå‚™ä»½
- **ISR**ï¼šèˆ‡ Leader ä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆ

### ISRï¼ˆIn-Sync Replicasï¼‰

```
ISR = Leader + åŒæ­¥çš„ Followers

ç¤ºä¾‹ï¼š
Leader: Broker 1
All Replicas: [Broker 1, Broker 2, Broker 3]
ISR: [Broker 1, Broker 2]  â† Broker 3 è½å¾Œï¼Œä¸åœ¨ ISR ä¸­
```

**ISR çš„é‡è¦æ€§**ï¼š
- åªæœ‰ ISR ä¸­çš„å‰¯æœ¬å¯ä»¥è¢«é¸ç‚ºæ–° Leader
- `acks=all` ç­‰å¾…æ‰€æœ‰ ISR ç¢ºèª

### å‰¯æœ¬é…ç½®

```bash
# å‰µå»º Topic æ™‚æŒ‡å®šå‰¯æœ¬æ•¸
kafka-topics --create \
  --bootstrap-server localhost:9092 \
  --topic my-topic \
  --partitions 3 \
  --replication-factor 3
```

## Controller

### ä»€éº¼æ˜¯ Controllerï¼Ÿ

Controller æ˜¯ Kafka é›†ç¾¤ä¸­çš„ä¸€å€‹ç‰¹æ®Š Brokerï¼Œè² è²¬ï¼š

1. **Leader é¸èˆ‰**ï¼šç•¶ Leader å¤±æ•—æ™‚é¸èˆ‰æ–° Leader
2. **åˆ†å€åˆ†é…**ï¼šç®¡ç†åˆ†å€çš„å‰¯æœ¬åˆ†é…
3. **å…ƒæ•¸æ“šæ›´æ–°**ï¼šå°‡è®Šæ›´é€šçŸ¥çµ¦æ‰€æœ‰ Broker
4. **Broker ç®¡ç†**ï¼šç›£æ§ Broker çš„åŠ å…¥å’Œé›¢é–‹

### Controller é¸èˆ‰

```
é›†ç¾¤å•Ÿå‹•ï¼š
1. æ‰€æœ‰ Broker å‘ ZooKeeper è¨»å†Š
2. ç¬¬ä¸€å€‹æˆåŠŸå‰µå»º /controller ç¯€é»çš„æˆç‚º Controller
3. å…¶ä»– Broker ç›£è½ Controller è®ŠåŒ–

Controller å¤±æ•—ï¼š
1. ZooKeeper æª¢æ¸¬åˆ° Controller é›¢ç·š
2. è§¸ç™¼æ–°çš„é¸èˆ‰
3. æ–° Controller æ¥ç®¡è·è²¬
```

## ZooKeeper çš„ä½œç”¨

### å‚³çµ± Kafkaï¼ˆä½¿ç”¨ ZooKeeperï¼‰

```
ZooKeeper è² è²¬ï¼š
- Broker è¨»å†Šå’Œç™¼ç¾
- Controller é¸èˆ‰
- Topic é…ç½®
- Consumer Group å…ƒæ•¸æ“šï¼ˆèˆŠç‰ˆæœ¬ï¼‰
- ACL æ¬Šé™ç®¡ç†

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ZooKeeper  â”‚
â”‚   Ensemble  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
Kafka  Kafka
Broker Broker
```

### KRaft æ¨¡å¼ï¼ˆæ–°æ¶æ§‹ï¼‰

Kafka 2.8+ å¼•å…¥ KRaftï¼ˆKafka Raftï¼‰ï¼Œä¸å†ä¾è³´ ZooKeeperï¼š

```
KRaft æ¨¡å¼ï¼š
- Kafka è‡ªå·±ç®¡ç†å…ƒæ•¸æ“š
- ä½¿ç”¨ Raft å…±è­˜ç®—æ³•
- ç°¡åŒ–éƒ¨ç½²å’Œé‹ç¶­
- æ›´å¥½çš„æ€§èƒ½

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kafka Cluster      â”‚
â”‚  (å…§å»º Raft å…ƒæ•¸æ“š)  â”‚
â”‚                     â”‚
â”‚  Broker + KRaft     â”‚
â”‚  Broker + KRaft     â”‚
â”‚  Broker + KRaft     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•…éšœæ¢å¾©

### å ´æ™¯ 1ï¼šFollower å¤±æ•—

```
å½±éŸ¿ï¼š
- Leader ç¹¼çºŒæœå‹™
- ISR ç¸®å°
- å¯é æ€§ç•¥å¾®ä¸‹é™

æ¢å¾©ï¼š
1. Follower é‡å•Ÿ
2. å¾ Leader åŒæ­¥æ•¸æ“š
3. è¿½ä¸Šé€²åº¦å¾Œé‡æ–°åŠ å…¥ ISR
```

### å ´æ™¯ 2ï¼šLeader å¤±æ•—

```
éç¨‹ï¼š
1. Controller æª¢æ¸¬åˆ° Leader å¤±æ•—
2. å¾ ISR ä¸­é¸èˆ‰æ–° Leader
3. æ›´æ–°å…ƒæ•¸æ“š
4. é€šçŸ¥æ‰€æœ‰ Broker å’Œ Client
5. æ–° Leader é–‹å§‹æœå‹™

æ™‚é–“ï¼šé€šå¸¸å¹¾ç§’å…§å®Œæˆ
```

### å ´æ™¯ 3ï¼šController å¤±æ•—

```
éç¨‹ï¼š
1. ZooKeeper æª¢æ¸¬åˆ° Controller å¤±æ•—
2. è§¸ç™¼æ–°çš„ Controller é¸èˆ‰
3. æ–° Controller åˆå§‹åŒ–
4. æ¢å¾©æ­£å¸¸æ“ä½œ

å½±éŸ¿ï¼šçŸ­æš«çš„ç®¡ç†æ“ä½œæš«åœ
```

## é›†ç¾¤æ“´å±•

### æ·»åŠ  Broker

```bash
# 1. é…ç½®æ–° Broker
# config/server.properties
broker.id=4
listeners=PLAINTEXT://new-broker:9092
log.dirs=/var/kafka-logs

# 2. å•Ÿå‹•æ–° Broker
kafka-server-start.sh config/server.properties

# 3. æ–° Broker è‡ªå‹•åŠ å…¥é›†ç¾¤
# ä½†ä¸æœƒè‡ªå‹•åˆ†é…ç¾æœ‰åˆ†å€

# 4. æ‰‹å‹•é‡æ–°åˆ†é…åˆ†å€ï¼ˆå¯é¸ï¼‰
kafka-reassign-partitions.sh ...
```

### ç§»é™¤ Broker

```bash
# 1. å°‡åˆ†å€é·ç§»åˆ°å…¶ä»– Broker
# 2. ç¢ºä¿æ²’æœ‰åˆ†å€åœ¨æ­¤ Broker ä¸Š
# 3. é—œé–‰ Broker
kafka-server-stop.sh
```

## é…ç½®è¦é»

### Broker æ ¸å¿ƒé…ç½®

```properties
# Broker ID
broker.id=1

# ç›£è½åœ°å€
listeners=PLAINTEXT://localhost:9092

# æ—¥èªŒç›®éŒ„
log.dirs=/var/kafka-logs

# ZooKeeper é€£æ¥
zookeeper.connect=localhost:2181

# å‰¯æœ¬è¨­ç½®
default.replication.factor=3
min.insync.replicas=2

# è‡ªå‹•å‰µå»º Topic
auto.create.topics.enable=false
```

## ç›£æ§å‘½ä»¤

```bash
# æŸ¥çœ‹é›†ç¾¤ Broker
kafka-broker-api-versions --bootstrap-server localhost:9092

# æŸ¥çœ‹ Topic çš„å‰¯æœ¬åˆ†ä½ˆ
kafka-topics --describe --bootstrap-server localhost:9092 --topic my-topic

# è¼¸å‡ºç¤ºä¾‹ï¼š
Topic: my-topic    PartitionCount: 3    ReplicationFactor: 3
  Partition: 0    Leader: 1    Replicas: 1,2,3    Isr: 1,2,3
  Partition: 1    Leader: 2    Replicas: 2,3,1    Isr: 2,3,1
  Partition: 2    Leader: 3    Replicas: 3,1,2    Isr: 3,1,2
```

## å°çµ

æœ¬ç« å­¸ç¿’äº†ï¼š

1. **Kafka é›†ç¾¤æ¶æ§‹**ï¼šå¤š Broker å”åŒå·¥ä½œ
2. **Broker è·è²¬**ï¼šæ¥æ”¶ã€å­˜å„²ã€æœå‹™ã€å‰¯æœ¬ç®¡ç†
3. **å‰¯æœ¬æ©Ÿåˆ¶**ï¼šLeader/Followerã€ISR
4. **Controller**ï¼šé›†ç¾¤ç®¡ç†è€…
5. **æ•…éšœæ¢å¾©**ï¼šè‡ªå‹•é¸èˆ‰å’Œæ¢å¾©
6. **ZooKeeper vs KRaft**ï¼šå…ƒæ•¸æ“šç®¡ç†æ¼”é€²

## ä¸‹ä¸€æ­¥

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼š13 - æ•¸æ“šå­˜å„²èˆ‡æ—¥èªŒ](../13-data-storage/README.md)

---

[è¿”å›ç›®éŒ„](../README.md)

