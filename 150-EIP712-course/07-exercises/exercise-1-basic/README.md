# ç·´ç¿’ 1ï¼šæŠ•ç¥¨ç°½åç³»çµ±ï¼ˆåˆç´šï¼‰

> å¯¦ç¾ä¸€å€‹éˆä¸‹ç°½åã€éˆä¸Šé©—è­‰çš„æŠ•ç¥¨ç³»çµ±

## ğŸ“‹ éœ€æ±‚èªªæ˜

ä½ éœ€è¦å¯¦ç¾ä¸€å€‹å»ä¸­å¿ƒåŒ–æŠ•ç¥¨ç³»çµ±ï¼Œå…·å‚™ä»¥ä¸‹åŠŸèƒ½ï¼š

### åŠŸèƒ½éœ€æ±‚

1. **å‰µå»ºææ¡ˆ**
   - ä»»ä½•äººéƒ½å¯ä»¥å‰µå»ºææ¡ˆ
   - ææ¡ˆåŒ…å«ï¼šIDã€æ¨™é¡Œã€æè¿°ã€æˆªæ­¢æ™‚é–“

2. **éˆä¸‹ç°½åæŠ•ç¥¨**
   - ä½¿ç”¨è€…ä½¿ç”¨ EIP712 ç°½ç½²æŠ•ç¥¨
   - æŠ•ç¥¨åŒ…å«ï¼šææ¡ˆ IDã€æ”¯æŒ/åå°ã€æŠ•ç¥¨è€…åœ°å€ã€nonce

3. **æäº¤ç°½å**
   - ä»»ä½•äººéƒ½å¯ä»¥æäº¤æœ‰æ•ˆç°½ååˆ°éˆä¸Š
   - æ‰¹é‡æäº¤å¤šå€‹ç°½åï¼ˆgas å„ªåŒ–ï¼‰

4. **é˜²è­·æ©Ÿåˆ¶**
   - æ¯å€‹åœ°å€åªèƒ½å°åŒä¸€ææ¡ˆæŠ•ä¸€æ¬¡ç¥¨
   - éæœŸçš„æŠ•ç¥¨ç„¡æ•ˆ
   - é‡è¤‡çš„ç°½åç„¡æ•ˆ

5. **çµæœçµ±è¨ˆ**
   - æŸ¥è©¢ææ¡ˆçš„æ”¯æŒ/åå°ç¥¨æ•¸
   - æŸ¥è©¢æŸåœ°å€æ˜¯å¦å·²æŠ•ç¥¨

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæ­¤ç·´ç¿’å¾Œï¼Œä½ å°‡èƒ½å¤ ï¼š

- [x] å®šç¾©å’Œä½¿ç”¨ EIP712 çµæ§‹åŒ–æ•¸æ“š
- [x] åœ¨ Solidity ä¸­é©—è­‰ EIP712 ç°½å
- [x] ä½¿ç”¨ nonce é˜²æ­¢é‡æ”¾æ”»æ“Š
- [x] åœ¨å‰ç«¯ç”Ÿæˆå’Œæäº¤ç°½å
- [x] è™•ç†æ‰¹é‡æ“ä½œä»¥å„ªåŒ– gas

## ğŸ“ æ•¸æ“šçµæ§‹

### Proposalï¼ˆææ¡ˆï¼‰

```solidity
struct Proposal {
    uint256 id;
    string title;
    string description;
    uint256 deadline;
    uint256 yesVotes;
    uint256 noVotes;
}
```

### Voteï¼ˆæŠ•ç¥¨ï¼‰

```solidity
struct Vote {
    uint256 proposalId;  // ææ¡ˆ ID
    bool support;        // true=æ”¯æŒ, false=åå°
    address voter;       // æŠ•ç¥¨è€…åœ°å€
    uint256 nonce;       // é˜²æ­¢é‡æ”¾
}
```

## ğŸ’¡ æç¤º

### 1. Domain Separator

```solidity
DOMAIN_SEPARATOR = keccak256(
    abi.encode(
        DOMAIN_TYPEHASH,
        keccak256(bytes("VotingSystem")),
        keccak256(bytes("1")),
        block.chainid,
        address(this)
    )
);
```

### 2. Type Hash

```solidity
VOTE_TYPEHASH = keccak256(
    "Vote(uint256 proposalId,bool support,address voter,uint256 nonce)"
);
```

### 3. é©—è­‰é‚è¼¯

```solidity
function verify(Vote memory vote, bytes memory signature) {
    // 1. æª¢æŸ¥ææ¡ˆæ˜¯å¦å­˜åœ¨ä¸”æœªéæœŸ
    // 2. æª¢æŸ¥æ˜¯å¦å·²æŠ•ç¥¨
    // 3. è¨ˆç®— struct hash
    // 4. è¨ˆç®— digest
    // 5. æ¢å¾©ç°½åè€…åœ°å€
    // 6. é©—è­‰åœ°å€åŒ¹é…
}
```

### 4. Nonce ç®¡ç†

```solidity
mapping(address => uint256) public nonces;

// ä½¿ç”¨æ™‚
require(nonces[voter] == vote.nonce, "Invalid nonce");
nonces[voter]++;
```

## ğŸ èµ·å§‹ä»£ç¢¼

è«‹æŸ¥çœ‹ [starter/VotingSystem.sol](./starter/VotingSystem.sol)

åˆç´„æ¡†æ¶å·²ç¶“æä¾›ï¼Œä½ éœ€è¦å¯¦ç¾ï¼š

- [ ] `verifyVote()` - é©—è­‰å–®å€‹æŠ•ç¥¨ç°½å
- [ ] `submitVote()` - æäº¤å–®å€‹æŠ•ç¥¨
- [ ] `submitVotes()` - æ‰¹é‡æäº¤æŠ•ç¥¨
- [ ] `_recordVote()` - è¨˜éŒ„æŠ•ç¥¨å…§éƒ¨é‚è¼¯

å‰ç«¯éƒ¨åˆ† [starter/vote-frontend.ts](./starter/vote-frontend.ts)ï¼š

- [ ] ç”ŸæˆæŠ•ç¥¨ç°½å
- [ ] æäº¤ç°½ååˆ°åˆç´„
- [ ] æŸ¥è©¢æŠ•ç¥¨çµæœ

## âœ… æª¢æŸ¥æ¸…å–®

### åŠŸèƒ½å¯¦ç¾

- [ ] å¯ä»¥å‰µå»ºææ¡ˆ
- [ ] å¯ä»¥ç°½ç½²æŠ•ç¥¨
- [ ] å¯ä»¥æäº¤ç°½å
- [ ] å¯ä»¥æ‰¹é‡æäº¤
- [ ] å¯ä»¥æŸ¥è©¢çµæœ

### å®‰å…¨æ€§

- [ ] é˜²æ­¢é‡è¤‡æŠ•ç¥¨
- [ ] é˜²æ­¢éæœŸæŠ•ç¥¨
- [ ] é˜²æ­¢é‡æ”¾æ”»æ“Šï¼ˆnonceï¼‰
- [ ] ç°½åé©—è­‰æ­£ç¢º
- [ ] åœ°å€æ¢å¾©æ­£ç¢º

### ä»£ç¢¼è³ªé‡

- [ ] æ‰€æœ‰å‡½æ•¸éƒ½æœ‰è¨»é‡‹
- [ ] ä½¿ç”¨äº‹ä»¶è¨˜éŒ„é‡è¦æ“ä½œ
- [ ] éŒ¯èª¤è™•ç†å®Œå–„
- [ ] è®Šé‡å‘½åæ¸…æ™°

### æ¸¬è©¦

- [ ] æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] é‚Šç•Œæ¢ä»¶æ¸¬è©¦
- [ ] è² é¢æ¸¬è©¦ï¼ˆé æœŸå¤±æ•—çš„æ¡ˆä¾‹ï¼‰

## ğŸ§ª æ¸¬è©¦

é‹è¡Œæ¸¬è©¦ï¼š

```bash
cd 150-EIP712
npx hardhat test test/VotingSystem.test.ts
```

æ¸¬è©¦æ¡ˆä¾‹åŒ…æ‹¬ï¼š

1. âœ… å‰µå»ºææ¡ˆ
2. âœ… ç”Ÿæˆæœ‰æ•ˆç°½å
3. âœ… æäº¤æœ‰æ•ˆæŠ•ç¥¨
4. âœ… æ‹’çµ•ç„¡æ•ˆç°½å
5. âœ… æ‹’çµ•é‡è¤‡æŠ•ç¥¨
6. âœ… æ‹’çµ•éæœŸæŠ•ç¥¨
7. âœ… æ‰¹é‡æäº¤æŠ•ç¥¨
8. âœ… æ­£ç¢ºçµ±è¨ˆçµæœ

## ğŸ“Š è©•åˆ†æ¨™æº–

| é …ç›® | åˆ†æ•¸ | èªªæ˜ |
|------|------|------|
| åŸºæœ¬åŠŸèƒ½ | 40 | å‰µå»ºææ¡ˆã€ç°½åã€æäº¤ã€æŸ¥è©¢ |
| å®‰å…¨æ€§ | 30 | é˜²é‡æ”¾ã€é˜²éæœŸã€ç°½åé©—è­‰ |
| Gas å„ªåŒ– | 15 | æ‰¹é‡æ“ä½œã€å­˜å„²å„ªåŒ– |
| ä»£ç¢¼è³ªé‡ | 15 | è¨»é‡‹ã€çµæ§‹ã€å¯è®€æ€§ |
| **ç¸½åˆ†** | **100** | |

### åŠæ ¼ï¼š60 åˆ†
### è‰¯å¥½ï¼š80 åˆ†
### å„ªç§€ï¼š90 åˆ†

## ğŸ’ª æŒ‘æˆ°

å®ŒæˆåŸºæœ¬è¦æ±‚å¾Œï¼Œå¯ä»¥å˜—è©¦ï¼š

### æŒ‘æˆ° 1ï¼šå§”è¨—æŠ•ç¥¨

å…è¨±ä½¿ç”¨è€…å§”è¨—æŠ•ç¥¨æ¬Šçµ¦å…¶ä»–åœ°å€ã€‚

```solidity
struct DelegatedVote {
    uint256 proposalId;
    bool support;
    address voter;        // åŸå§‹æŠ•ç¥¨è€…
    address delegate;     // å§”è¨—äºº
    uint256 nonce;
}
```

### æŒ‘æˆ° 2ï¼šæŠ•ç¥¨æ¬Šé‡

æ ¹æ“šä»£å¹£æŒæœ‰é‡è¨­ç½®æŠ•ç¥¨æ¬Šé‡ã€‚

```solidity
function getVotingPower(address voter) public view returns (uint256);
```

### æŒ‘æˆ° 3ï¼šææ¡ˆç‹€æ…‹ç®¡ç†

å¯¦ç¾ææ¡ˆçš„ä¸åŒç‹€æ…‹ï¼šå¾…å®šã€æ´»èºã€é€šéã€æ‹’çµ•ã€åŸ·è¡Œã€‚

```solidity
enum ProposalState {
    Pending,
    Active,
    Defeated,
    Succeeded,
    Executed
}
```

## ğŸ” å¸¸è¦‹å•é¡Œ

### Q1: å¦‚ä½•èª¿è©¦ç°½åé©—è­‰å¤±æ•—ï¼Ÿ

```solidity
// æ·»åŠ èª¿è©¦å‡½æ•¸
function getVoteDigest(Vote memory vote) public view returns (bytes32) {
    return keccak256(
        abi.encodePacked(
            "\x19\x01",
            DOMAIN_SEPARATOR,
            getVoteStructHash(vote)
        )
    );
}
```

ç„¶å¾Œåœ¨å‰ç«¯å°æ¯”ï¼š
```typescript
const contractDigest = await contract.getVoteDigest(vote);
const frontendDigest = ethers.TypedDataEncoder.hash(domain, types, vote);
console.log("ä¸€è‡´ï¼Ÿ", contractDigest === frontendDigest);
```

### Q2: Nonce æ‡‰è©²åœ¨å“ªè£¡éå¢ï¼Ÿ

```solidity
// âœ… æ­£ç¢ºï¼šåœ¨é©—è­‰æˆåŠŸå¾Œï¼Œè¨˜éŒ„æŠ•ç¥¨å‰
function submitVote(Vote memory vote, bytes memory signature) public {
    require(verifyVote(vote, signature), "Invalid signature");
    nonces[vote.voter]++;  // é©—è­‰é€šéå¾Œç«‹å³éå¢
    _recordVote(vote);
}
```

### Q3: æ‰¹é‡æ“ä½œå¦‚ä½•å„ªåŒ– gasï¼Ÿ

```solidity
// æç¤ºï¼š
// 1. ä½¿ç”¨ calldata è€Œä¸æ˜¯ memory
// 2. æ‰¹é‡æª¢æŸ¥ï¼Œå–®æ¬¡å¤±æ•—ä¸å½±éŸ¿å…¶ä»–
// 3. ä½¿ç”¨äº‹ä»¶è¨˜éŒ„ï¼Œè€Œä¸æ˜¯è¿”å›å€¼
function submitVotes(
    Vote[] calldata votes,
    bytes[] calldata signatures
) external {
    for (uint i = 0; i < votes.length; i++) {
        // ä½¿ç”¨ try-catch é¿å…å–®å€‹å¤±æ•—å½±éŸ¿æ•´é«”
    }
}
```

## ğŸ“š ç›¸é—œç« ç¯€

å¦‚æœé‡åˆ°å›°é›£ï¼Œè¤‡ç¿’é€™äº›ç« ç¯€ï¼š

- [ç¬¬ä¸€ç« ï¼šæ¦‚å¿µèˆ‡å¿ƒæ™ºæ¨¡å‹](../../01-fundamentals/README.md)
- [ç¬¬äºŒç« ï¼šç·¨ç¢¼æµç¨‹](../../02-encoding-flow/README.md)
- [ç¬¬ä¸‰ç« ï¼šç°½åçµ„ä»¶](../../03-signature-components/README.md)
- [ç¬¬å››ç« ï¼šHello World](../../04-hello-world/README.md)

## ğŸ“ å­¸ç¿’å»ºè­°

1. **å…ˆç†è§£éœ€æ±‚**ï¼šä»”ç´°é–±è®€éœ€æ±‚ï¼Œç•«å‡ºæ•¸æ“šæµç¨‹åœ–
2. **åˆ†æ­¥å¯¦ç¾**ï¼šä¸è¦æƒ³ä¸€æ¬¡å®Œæˆæ‰€æœ‰åŠŸèƒ½
3. **é »ç¹æ¸¬è©¦**ï¼šå¯¦ç¾ä¸€å€‹åŠŸèƒ½å°±æ¸¬è©¦ä¸€å€‹
4. **åƒè€ƒç¯„ä¾‹**ï¼šç¬¬å››ç« çš„ SimpleMessage æ˜¯å¾ˆå¥½çš„åƒè€ƒ
5. **æœ€å¾Œå„ªåŒ–**ï¼šåŠŸèƒ½æ­£ç¢ºå¾Œå†è€ƒæ…® gas å„ªåŒ–

## â±ï¸ é ä¼°æ™‚é–“

- ç†è§£éœ€æ±‚ï¼š15 åˆ†é˜
- å¯¦ç¾åˆç´„ï¼š45 åˆ†é˜
- å¯¦ç¾å‰ç«¯ï¼š30 åˆ†é˜
- æ¸¬è©¦èª¿è©¦ï¼š30 åˆ†é˜
- **ç¸½è¨ˆï¼š2 å°æ™‚**

---

## é–‹å§‹å§ï¼ ğŸš€

```bash
cd starter/
# é–±è®€èµ·å§‹ä»£ç¢¼
# å¯¦ç¾ TODO éƒ¨åˆ†
# é‹è¡Œæ¸¬è©¦
# å°æ¯”è§£ç­”
```

ç¥ä½ å¥½é‹ï¼å¦‚æœé‡åˆ°å›°é›£ï¼Œè¨˜å¾—æŸ¥çœ‹æç¤ºå’Œåƒè€ƒå‰é¢çš„ç« ç¯€ã€‚

---

[è¿”å›ç·´ç¿’åˆ—è¡¨](../README.md) | [æŸ¥çœ‹åƒè€ƒè§£ç­”](./solution/README.md)

